<!DOCTYPE html>
<html data-wf-domain="ronautradio.la" data-wf-page="5f4bdfc87623ea7b20d24cf4" data-wf-site="5f4bdfc87623ea5cc5d24cf3">
<head>
    <meta charset="utf-8" />
    <title>Ronaut Radio</title>
    <link rel="icon" type="image/png" href="assets/favicon.png" />
    <link rel="apple-touch-icon" href="assets/favicon.png" />
    <meta content="Ronaut Radio - Los Angeles-based independent radio station dedicated to vinyl-only curation. Broadcasting live shows, rare finds, and timeless classics straight from the City of Angels." name="description" />
    <meta content="Ronaut Radio" property="og:title" />
    <meta content="Ronaut Radio - Los Angeles-based independent radio station dedicated to vinyl-only curation. Broadcasting live shows, rare finds, and timeless classics straight from the City of Angels." property="og:description" />
    <meta content="https://ronautradio.la/assets/favicon.png" property="og:image" />
    <meta content="Ronaut Radio" property="twitter:title" />
    <meta content="Ronaut Radio - Los Angeles-based independent radio station dedicated to vinyl-only curation. Broadcasting live shows, rare finds, and timeless classics straight from the City of Angels." property="twitter:description" />
    <meta content="https://ronautradio.la/assets/favicon.png" property="twitter:image" />
    <meta property="og:type" content="website" />
    <meta content="summary_large_image" name="twitter:card" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta content="0JM6yM9qSeoDRG89r3oa7rtHD8znpZcMgbPh_98fWhs" name="google-site-verification" />
    <link href="https://fonts.googleapis.com/" rel="preconnect" />
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin="anonymous" />
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
    <script type="text/javascript">
        WebFont.load({ google: { families: ["Oswald:200,300,400,500,600,700"] } });
    </script>
    <script type="text/javascript">
        ! function(o, c) { var n = c.documentElement, t = " w-mod-"; n.className += t + "js", ("ontouchstart" in o || o.DocumentTouch && c instanceof DocumentTouch) && (n.className += t + "touch") }(window, document);
    </script>
    <link href="assets/favicon.png" rel="shortcut icon" type="image/png" />
    <link href="index.html" rel="canonical" />
    <!-- PWA -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#000000" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="Ronaut" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KZ8YVCHYY7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-KZ8YVCHYY7');
    </script>
    <meta name="apple-itunes-app" content="app-id=1091128189">
    <meta property="og:video" content="https://stream.ronautradio.la/live/hls/stream.m3u8" />
    <meta property="og:video:type" content="application/x-mpegURL" />
    <meta property="og:video:width" content="1280" />
    <meta property="og:video:height" content="720" />
    <meta property="og:type" content="video">
    
    <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet" />

    <style>
        /* Theme variables */
        :root {
            --bg-primary: #f4f4f4;
            --bg-secondary: #fff;
            --text-primary: #000;
            --text-secondary: #333;
            --text-muted: #666;
            --border-color: #ddd;
            --card-bg: #fff;
            --card-shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --text-primary: #fff;
            --text-secondary: #ccc;
            --text-muted: #999;
            --border-color: #444;
            --card-bg: #2a2a2a;
            --card-shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            margin: 0;
            font-family: Oswald, sans-serif;
            text-align: center;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .w-container {
            max-width: 940px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            background: var(--bg-primary);
            position: relative;
            z-index: 1;
        }

        .w-inline-block {
            max-width: 100%;
            display: inline-block;
        }
        
        .w-layout-blockcontainer {
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        h1, h2, h3 {
            font-family: Oswald, sans-serif;
            text-align: center;
            margin: 20px auto;
        }
        
        .main-title {
            font-size: 48px;
            font-weight: 300;
            letter-spacing: 2px;
            margin: 0;
        }

        #top-player-container {
            width: 100%;
            background: black;
            position: relative;
            z-index: 1000;
        }

        #player-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            background: black;
            padding-top: 56.25%;
        }

        #ronaut-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Ensure Video.js doesn't cover our overlays on iOS */
        .video-js {
            z-index: 1 !important;
        }
        .video-js .vjs-tech {
            z-index: 1 !important;
        }
        .video-js .vjs-control-bar {
            z-index: 90 !important;
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            /* Safari/iOS: force overlay above video element */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        /* Audio-reactive visuals */
        #audio-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            /* Safari/iOS: force GPU layer */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }


        #edge-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            box-shadow: inset 0 0 60px rgba(255, 255, 255, 0);
            transition: box-shadow 0.1s ease-out;
        }

        /* Energy meter - intensity bar directly below waveform */
        #energy-meter {
            position: absolute;
            bottom: 8px;
            right: 20px;
            width: 280px;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            border-radius: 2px;
        }

        #energy-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #fff, #ff6b6b);
            transition: width 0.05s ease-out;
            border-radius: 2px;
        }

        /* AM-style waveform visualizer - stacked directly above energy meter */
        #waveform-container {
            position: absolute;
            bottom: 11px; /* 8px (energy-meter bottom) + 3px (energy-meter height) = 11px */
            right: 20px;
            width: 280px;
            height: 70px;
            pointer-events: none;
            z-index: 9999;
            /* Safari/iOS: force GPU layer to appear above video */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        #waveform-canvas {
            width: 100%;
            height: 100%;
            opacity: 0.9;
            /* Safari: ensure canvas renders */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        /* Energy meter also needs higher z-index for Safari */
        #energy-meter {
            z-index: 9998;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        /* Mobile: hide waveform (doesn't work reliably on mobile) */
        @media (max-width: 767px) {
            #waveform-container {
                display: none !important;
            }

            #waveform-canvas {
                display: none !important;
            }

            #energy-meter {
                display: none !important;
            }
        }

        @media (max-width: 480px) {
            #waveform-container,
            #waveform-canvas,
            #energy-meter {
                display: none !important;
            }
        }

        #ticker {
            color: white;
            font-size: 16px;
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: none;
            white-space: nowrap;
            overflow: hidden;
            animation: scroll-left 15s linear infinite;
        }

        @keyframes scroll-left {
            from { transform: translateX(100%); }
            to { transform: translateX(-100%); }
        }

        #current-track {
            position: absolute;
            bottom: 44px;
            left: 12px;
            right: 20px;
            font-family: Oswald, sans-serif;
            font-size: 12px;
            font-weight: 300;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: none;
        }

        #cast-btn {
            position: absolute;
            bottom: 52px;
            right: 12px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            padding: 6px;
            pointer-events: auto;
            display: none;
            z-index: 101;
            transition: color 0.15s;
        }

        #cast-btn:hover { color: #fff; }

        #cast-btn svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
            display: block;
        }

        #cast-btn.casting { color: #fff; }

        #listener-count {
            position: absolute;
            top: 12px;
            right: 12px;
            font-family: Oswald, sans-serif;
            font-size: 11px;
            font-weight: 300;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.55);
            display: none;
        }

        #genre-filter {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .genre-btn {
            font-family: Oswald, sans-serif;
            font-size: 11px;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 4px 12px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .genre-btn.active, .genre-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        #next-live-banner {
            color: white;
            font-size: 14px;
            position: absolute;
            top: 15px;
            left: 20px;
            white-space: nowrap;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        #next-live-banner.visible {
            opacity: 1;
        }

        @media (max-width: 767px) {
            #next-live-banner {
                font-size: 12px;
                top: 12px;
                left: 10px;
            }
        }

        .share-container {
            text-align: center;
            margin: 20px 0;
            background: var(--bg-primary);
            position: relative;
            z-index: 1;
            padding: 20px 0;
        }

        #btn-share {
            font-family: Oswald, sans-serif;
            margin-top: 0;
            padding-left: 15px;
            padding-right: 15px;
            height: 52px;
            background: grey;
            border: 1px solid #000;
            font-size: 16px;
            color: #000;
            font-weight: 500;
            text-transform: uppercase;
            width: auto;
            cursor: pointer;
        }

        #btn-share:disabled {
            background: #000;
            color: #fff;
        }

        /* Theme Toggle Bar - fixed at top */
        #theme-toggle-bar {
            position: fixed;
            top: 0;
            right: 0;
            z-index: 10000;
            padding: 8px 12px;
            transition: top 0.12s ease-out;
        }

        #btn-theme {
            font-family: Oswald, sans-serif;
            padding: 6px 12px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            font-size: 12px;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            color: var(--text-primary);
        }

        #btn-theme:hover {
            background: var(--bg-secondary);
        }

        /* Show sun + "Light Mode" in dark mode, moon + "Dark Mode" in light mode */
        .theme-icon-light { display: none; }
        .theme-icon-dark { display: inline; }
        [data-theme="dark"] .theme-icon-light { display: inline; }
        [data-theme="dark"] .theme-icon-dark { display: none; }

        .social-links {
            max-width: 200px;
            margin: 20px auto;
            display: flex;
            justify-content: space-around;
            background: var(--bg-primary);
            position: relative;
            z-index: 1;
            padding: 20px;
        }
        
        .social-links img {
            width: 24px;
            height: 24px;
        }

        /* Dark mode: light gray for social icon images */
        [data-theme="dark"] .social-links img {
            filter: brightness(0) invert(1) opacity(0.6);
        }
        /* Discord inline SVG — restore brand blue in dark mode */
        [data-theme="dark"] .social-links a[href*="discord"] svg {
            color: #5865F2;
            opacity: 1;
        }

        .paragraph {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
            padding-left: 20px;
            padding-right: 20px;
            font-family: Oswald, sans-serif;
            font-size: 16px;
            line-height: 1.6;
        }
        
        /* Event Cards */
        .event-card {
            display: flex;
            border: 1px solid #000;
            margin-bottom: 15px;
            font-family: Oswald, sans-serif;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .event-date {
            background: #000;
            color: #fff;
            padding: 20px;
            min-width: 80px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .event-date .month {
            font-size: 12px;
            font-weight: 400;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .event-date .day {
            font-size: 32px;
            font-weight: 500;
            line-height: 1;
            margin: 4px 0;
        }
        .event-date .weekday {
            font-size: 11px;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
            opacity: 0.7;
        }
        .event-details {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .event-title {
            font-size: 18px;
            font-weight: 500;
            margin: 0 0 6px 0;
            letter-spacing: 0.5px;
        }
        .event-time {
            font-size: 13px;
            font-weight: 300;
            color: #666;
            margin: 0;
        }
        .event-actions {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            gap: 8px;
        }
        .event-actions a {
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 8px 12px;
            text-decoration: none;
            white-space: nowrap;
        }
        .event-actions .add-gcal {
            background: #000;
            color: #fff;
        }
        .event-actions .add-gcal:hover {
            background: #333;
        }
        .event-actions .add-ics {
            background: #fff;
            color: #000;
            border: 1px solid #000;
        }
        .event-actions .add-ics:hover {
            background: #f5f5f5;
        }
        @media (max-width: 500px) {
            .event-card { flex-direction: column; }
            .event-date { padding: 15px; flex-direction: row; gap: 10px; min-width: auto; }
            .event-date .day { font-size: 24px; margin: 0; }
            .event-actions { padding: 10px 15px; }
        }
        
        /* LIVE Badge */
        #live-badge {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1001;
            background: rgba(0, 0, 0, 0.7);
            color: #ff0000;
            font-family: Oswald, sans-serif;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            padding: 6px 14px;
            border: 1px solid #ff0000;
            align-items: center;
            gap: 8px;
        }

        #live-badge.active {
            display: flex;
        }

        #live-dot {
            width: 10px;
            height: 10px;
            background: #ff0000;
            border-radius: 50%;
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.8); }
        }

        /* Programme + Chat Stacked Layout */
        #programme-chat-row {
            max-width: 800px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            padding: 20px 10px;
            background: var(--bg-primary);
            position: relative;
            z-index: 1;
        }

        #programme-section {
            width: 100%;
            text-align: center;
            font-family: Oswald, sans-serif;
        }

        #programme-section h2 {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        #programme-date {
            font-family: Oswald, sans-serif;
            font-size: 14px;
            font-weight: 300;
            letter-spacing: 1px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 16px;
        }


        .programme-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 18px;
            font-weight: 300;
            letter-spacing: 0.5px;
            color: var(--text-primary);
        }

        .programme-item:first-child {
            border-top: 1px solid var(--border-color);
        }

        .programme-item.now-playing {
            background: var(--text-primary);
            color: var(--bg-primary);
            font-weight: 400;
            position: relative;
        }

        .programme-item .track-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .programme-item .track-time {
            flex-shrink: 0;
            font-size: 16px;
            opacity: 0.7;
        }

        .programme-item.now-playing .track-time {
            opacity: 1;
        }

        .programme-item.now-playing .progress-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff0000;
            transition: left 1s linear;
        }

        .programme-item.programme-past {
            opacity: 0.5;
            background: var(--bg-secondary);
        }

        .programme-item.programme-past .track-time {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .now-playing-dot {
            width: 10px;
            height: 10px;
            background: #ff0000;
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        #programme-live-message {
            text-align: center;
            font-size: 18px;
            font-weight: 300;
            letter-spacing: 1px;
            padding: 20px;
            display: none;
        }

        /* Chat column */
        #chat-column {
            width: 343px;
        }

        #chat-column h3 {
            font-family: Oswald, sans-serif;
            font-size: 20px;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        #chat-toggle {
            display: block;
            font-family: Oswald, sans-serif;
            font-size: 14px;
            font-weight: 300;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            background: none;
            border: 1px solid #ccc;
            color: #555;
            padding: 8px 20px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        #chat-toggle:hover {
            border-color: #000;
            color: #000;
        }

        #chat-body {
            overflow: hidden;
            display: none;
        }

        #chat-body.open {
            display: block;
        }

        /* Custom Chat Widget */
        #chat-widget {
            width: 343px;
            border: 1px solid var(--border-color);
            font-family: Oswald, sans-serif;
            background: var(--card-bg);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        #chat-header {
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        #chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 8px;
            font-size: 13px;
            font-weight: 300;
            color: var(--text-primary);
        }

        .chat-msg {
            margin-bottom: 4px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-msg .chat-time {
            font-size: 10px;
            color: #999;
            margin-right: 6px;
        }

        .chat-msg .chat-nick {
            font-weight: 500;
            margin-right: 6px;
        }

        #chat-input-row {
            display: flex;
            border-top: 1px solid var(--border-color);
        }

        #chat-nick {
            width: 70px;
            border: none;
            border-right: 1px solid var(--border-color);
            padding: 8px;
            font-family: Oswald, sans-serif;
            font-size: 12px;
            font-weight: 300;
            outline: none;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        #chat-msg {
            flex: 1;
            border: none;
            padding: 8px;
            font-family: Oswald, sans-serif;
            font-size: 13px;
            font-weight: 300;
            outline: none;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        #chat-send {
            border: none;
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        #chat-send:hover {
            background: var(--text-secondary);
        }

        #chat-discord-link {
            margin-top: 8px;
        }

        #chat-discord-link a {
            font-family: Oswald, sans-serif;
            font-size: 11px;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #999;
            text-decoration: none;
            transition: color 0.2s;
        }

        #chat-discord-link a:hover {
            color: #000;
        }

        /* Featured Residents - Simple list with detail panel */
        #featured-residents {
            max-width: 600px;
            margin: 40px auto 20px;
            padding: 20px;
            background: var(--bg-primary);
            position: relative;
            z-index: 1;
        }

        #featured-residents h2 {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 25px;
            text-align: center;
        }

        #residents-list {
            display: flex;
            flex-direction: column;
        }

        .resident-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .resident-row:first-child {
            border-top: 1px solid var(--border-color);
        }

        .resident-row:hover {
            background: var(--bg-secondary);
        }

        .resident-row img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .resident-row .name {
            font-family: Oswald, sans-serif;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
            flex: 1;
        }

        .resident-row .arrow {
            color: #999;
            font-size: 18px;
        }

        /* Detail panel (fullscreen overlay on click) */
        .resident-detail-panel {
            display: none;
            background: var(--bg-primary);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            overflow-y: auto;
        }

        .resident-detail-panel.active {
            display: flex;
        }

        .detail-close {
            position: absolute;
            top: 60px;
            right: 25px;
            font-size: 36px;
            color: var(--text-primary);
            cursor: pointer;
            z-index: 10;
            background: none;
            border: none;
            line-height: 1;
        }

        .detail-photo {
            flex: 0 0 45%;
            background-size: cover;
            background-position: center;
        }

        .detail-content {
            flex: 1;
            padding: 80px 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .detail-label {
            font-family: Oswald, sans-serif;
            font-size: 11px;
            font-weight: 500;
            color: #d4a32a;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .detail-name {
            font-family: Oswald, sans-serif;
            font-size: 42px;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 25px;
        }

        .detail-bio {
            font-family: Oswald, sans-serif;
            font-size: 14px;
            font-weight: 300;
            color: var(--text-muted);
            line-height: 1.8;
            margin-bottom: 25px;
        }

        .detail-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
        }

        .detail-links a {
            font-family: Oswald, sans-serif;
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-primary);
            text-decoration: none;
            padding: 8px 14px;
            border: 1px solid var(--text-primary);
            transition: all 0.2s;
        }

        .detail-links a:hover {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        [data-theme="dark"] .detail-links a {
            color: #fff;
            border-color: rgba(255, 255, 255, 0.5);
        }
        [data-theme="dark"] .detail-links a:hover {
            background: #fff;
            color: #1a1a1a;
        }

        .detail-sets-title {
            font-family: Oswald, sans-serif;
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 10px;
        }

        .detail-set-link {
            display: inline-block;
            font-family: Oswald, sans-serif;
            font-size: 14px;
            font-weight: 400;
            color: #d4a32a;
            text-decoration: underline;
            cursor: pointer;
            margin-right: 15px;
        }

        .detail-set-link:hover {
            color: #e8b93a;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .resident-detail-panel.active {
                flex-direction: column;
            }

            .detail-photo {
                flex: 0 0 260px;
                min-height: 260px;
                width: 100%;
                background-size: cover;
                background-position: top center;
            }

            .detail-content {
                padding: 30px 20px;
            }

            .detail-name {
                font-size: 28px;
            }

            .detail-bio {
                font-size: 13px;
            }
        }

        /* Staff Picks */
        #staff-picks {
            max-width: 1200px;
            margin: 40px auto 20px;
            padding: 0 20px;
            text-align: center;
        }

        #staff-picks h2 {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 25px;
        }

        #picks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        @media (min-width: 1024px) {
            #picks-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .pick-card {
            cursor: pointer;
            text-align: left;
            transition: opacity 0.2s;
        }

        .pick-card:hover {
            opacity: 0.8;
        }

        .pick-card img {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            display: block;
            background: var(--border-color);
        }

        .pick-card .pick-title {
            font-family: Oswald, sans-serif;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: 0.5px;
            margin-top: 10px;
            color: var(--text-primary);
        }

        .pick-card .pick-desc {
            font-family: Oswald, sans-serif;
            font-size: 13px;
            font-weight: 300;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .pick-card .pick-genres {
            font-family: Oswald, sans-serif;
            font-size: 11px;
            font-weight: 300;
            color: var(--text-muted);
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pick-card .pick-tracklist-toggle {
            font-family: Oswald, sans-serif;
            font-size: 12px;
            font-weight: 400;
            color: #000;
            margin-top: 8px;
            cursor: pointer;
            text-decoration: underline;
        }

        .pick-card .pick-tracklist-toggle:hover {
            color: #666;
        }

        .pick-card .pick-tracklist {
            display: none;
            font-family: Oswald, sans-serif;
            font-size: 11px;
            font-weight: 300;
            color: #333;
            margin-top: 6px;
            padding: 8px;
            background: #f5f5f5;
            max-height: 200px;
            overflow-y: auto;
        }

        .pick-card .pick-tracklist.open {
            display: block;
        }

        .pick-card .pick-tracklist .track {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .pick-card .pick-tracklist .track-time {
            color: #888;
            margin-right: 6px;
            cursor: pointer;
        }

        .pick-card .pick-tracklist .track-time:hover {
            color: #000;
            text-decoration: underline;
        }

        .pick-card .pick-tracklist .track.unidentified {
            color: #999;
            font-style: italic;
            border-left: 2px solid #ff6600;
            padding-left: 6px;
            margin-left: -8px;
        }

        .pick-card .pick-tracklist .track.unidentified .help-id {
            color: #ff6600;
            font-weight: 400;
            font-style: normal;
            cursor: pointer;
        }

        .pick-card .pick-tracklist .track.unidentified .help-id:hover {
            text-decoration: underline;
        }

        /* Dark mode: schedule separators + staff picks legibility */
        [data-theme="dark"] .programme-item { border-color: #555; }
        [data-theme="dark"] .programme-item:first-child { border-color: #555; }
        [data-theme="dark"] .programme-item.now-playing {
            background: #2e2e2e;
            color: #fff;
            border: 1px solid rgba(200, 0, 0, 0.45);
        }
        [data-theme="dark"] .programme-item.now-playing .track-time {
            color: #ff3333;
            opacity: 1;
        }
        [data-theme="dark"] .pick-card .pick-desc { color: #bbb; }
        [data-theme="dark"] .pick-card .pick-genres { color: #aaa; }

        /* Dark mode tracklist */
        [data-theme="dark"] .pick-card .pick-tracklist { background: #1f1610; color: #e8c4a0; }
        [data-theme="dark"] .pick-card .pick-tracklist-toggle { color: #ff6600; }
        [data-theme="dark"] .pick-card .pick-tracklist-toggle:hover { color: #ff8833; }
        [data-theme="dark"] .pick-card .pick-tracklist .track-time { color: #ff6600; }
        [data-theme="dark"] .pick-card .pick-tracklist .track-time:hover { color: #ff8833; }
        [data-theme="dark"] .pick-card .pick-tracklist .track.unidentified { color: #b08060; border-left-color: #ff6600; }

        /* Help ID Modal */
        #help-id-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        #help-id-modal.open {
            display: flex;
        }

        #help-id-form {
            background: #fff;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            font-family: Oswald, sans-serif;
        }

        #help-id-form h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        #help-id-form .help-id-time {
            font-size: 13px;
            color: #888;
            margin-bottom: 15px;
        }

        #help-id-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            font-family: Oswald, sans-serif;
            font-size: 14px;
            font-weight: 300;
            box-sizing: border-box;
        }

        #help-id-form input:focus {
            outline: none;
            border-color: #000;
        }

        #help-id-form .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        #help-id-form button {
            flex: 1;
            padding: 10px;
            font-family: Oswald, sans-serif;
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 1px;
            cursor: pointer;
            border: 1px solid #000;
        }

        #help-id-form button.submit-btn {
            background: #000;
            color: #fff;
        }

        #help-id-form button.cancel-btn {
            background: #fff;
            color: #000;
        }

        #help-id-form .success-msg {
            color: #090;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        /* Back to Live banner */
        #back-to-live {
            display: none;
            background: #000;
            color: #fff;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            font-family: Oswald, sans-serif;
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            z-index: 1002;
        }

        #back-to-live:hover {
            background: #333;
        }

        /* Mini Player */
        #mini-player {
            position: fixed;
            background: #000;
            color: #fff;
            font-family: Oswald, sans-serif;
            z-index: 9998;
            display: none;
            align-items: center;
            gap: 12px;
            padding: 10px 15px 10px 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #mini-player.visible {
            display: flex;
        }

        #mini-player .mini-status {
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #ff4444;
        }

        #mini-player .mini-title {
            font-size: 13px;
            font-weight: 400;
            letter-spacing: 0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        #mini-player .mini-video-wrap {
            width: 180px;
            height: 101px;
            background: #000;
            overflow: hidden;
            flex-shrink: 0;
            margin: -10px 0 -10px 0;
        }

        #mini-player #mini-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            display: block;
        }

        #mini-player .mini-info {
            cursor: pointer;
        }

        #mini-player .mini-info:hover .mini-title {
            text-decoration: underline;
        }

        #mini-player .mini-controls {
            display: flex;
            gap: 8px;
        }

        #mini-player .mini-btn {
            background: none;
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            padding: 0;
            opacity: 0.8;
        }

        #mini-player .mini-btn:hover {
            opacity: 1;
        }

        #mini-player .mini-btn svg {
            width: 18px;
            height: 18px;
            fill: #fff;
        }

        /* Desktop: top-left */
        @media (min-width: 768px) {
            #mini-player {
                top: 0;
                left: 0;
                padding: 0 15px 0 0;
            }
            #mini-player .mini-video-wrap {
                margin: 0;
            }
        }

        /* Mobile: bottom sticky bar */
        @media (max-width: 767px) {
            #mini-player {
                bottom: 0;
                left: 0;
                right: 0;
                justify-content: space-between;
                border-top: 1px solid #333;
                padding: 0 12px 0 0;
            }
            #mini-player .mini-video-wrap {
                width: 120px;
                height: 68px;
                margin: 0;
            }
            #mini-player .mini-title {
                max-width: none;
                flex: 1;
            }
        }

        /* Responsive */
        @media (max-width: 767px) {
            .main-title {
                font-size: 32px;
                letter-spacing: 1px;
            }
            #chat-column {
                width: 100%;
            }
            #chat-widget {
                width: 100%;
            }
            /* Center staff picks grid on mobile */
            #picks-grid {
                justify-items: center;
            }
            .pick-card {
                max-width: 400px;
                width: 100%;
                text-align: center;
            }
            .pick-card img {
                margin: 0 auto;
            }
            /* Mobile: just show icon, no text */
            .theme-text {
                display: none;
            }
            #btn-theme {
                padding: 4px 8px;
                font-size: 10px;
            }
            /* Mobile theme toggle — JS positions it dynamically via scroll */
            #theme-toggle-bar {
                top: 60px; /* safe initial fallback; JS overrides immediately */
                right: 5px;
                transition: top 0.08s linear;
            }
        }

        /* Asteroid Canvas Background */
        #asteroid-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Asteroid Background Canvas -->
    <canvas id="asteroid-canvas"></canvas>

    <!-- Theme Toggle Bar (fixed top) -->
    <div id="theme-toggle-bar">
        <button id="btn-theme" title="Toggle dark/light mode">
            <span class="theme-icon-light"><span class="theme-symbol">&#9728;&#65038;</span><span class="theme-text"> Light Mode</span></span>
            <span class="theme-icon-dark"><span class="theme-symbol">&#9790;&#65038;</span><span class="theme-text"> Dark Mode</span></span>
        </button>
    </div>

    <!-- Mini Player (appears when scrolling) -->
    <div id="mini-player">
        <div class="mini-video-wrap">
            <video id="mini-video" muted playsinline></video>
        </div>
        <div class="mini-info">
            <div class="mini-status">LIVE</div>
            <div class="mini-title">Loading...</div>
        </div>
        <div class="mini-controls">
            <button class="mini-btn" id="mini-play-btn" title="Play/Pause">
                <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
            </button>
            <button class="mini-btn" id="mini-mute-btn" title="Mute/Unmute">
                <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            </button>
            <button class="mini-btn" id="mini-cast-btn" title="Cast / AirPlay" style="display:none">
                <svg viewBox="0 0 24 24"><path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm18-7H5v1.63c3.96 1.28 7.09 4.41 8.37 8.37H19V7zM1 10v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11zm20-7H3c-1.1 0-2 .9-2 2v3h2V5h18v14h-7v2h7c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
            </button>
        </div>
    </div>

    <div id="top-player-container">
        <div id="player-container">
            <button id="cast-btn" title="Cast to TV / AirPlay">
                <svg viewBox="0 0 24 24"><path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm18-7H5v1.63c3.96 1.28 7.09 4.41 8.37 8.37H19V7zM1 10v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11zm20-7H3c-1.1 0-2 .9-2 2v3h2V5h18v14h-7v2h7c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
            </button>
            <video id="ronaut-player" class="video-js vjs-default-skin" controls muted playsinline webkit-playsinline x5-playsinline x-webkit-airplay="allow" preload="none" crossorigin="anonymous">
                <source src="https://stream.ronautradio.la/live/hls/stream.m3u8" type="application/x-mpegURL" />
                <source src="https://stream.ronautradio.la/live/audio/stream.mp3" type="audio/mpeg" />
            </video>
            <div id="audio-overlay">
                <div id="edge-pulse"></div>
            </div>
            <div id="overlay">
                <div id="live-badge"><div id="live-dot"></div>LIVE</div>
                <div id="ticker">Loading current set...</div>
                <div id="current-track"></div>
                <div id="listener-count"></div>
                <div id="energy-meter"><div id="energy-bar"></div></div>
                <div id="waveform-container">
                    <canvas id="waveform-canvas"></canvas>
                </div>
                <div id="next-live-banner"></div>
            </div>
        </div>
    </div>

    <!-- BACK TO LIVE BANNER (appears when playing a staff pick) -->
    <div id="back-to-live" onclick="backToLive()">&#8592; Back to Live Stream</div>

    <!-- HELP ID MODAL -->
    <div id="help-id-modal">
        <div id="help-id-form">
            <h3>HELP IDENTIFY THIS TRACK</h3>
            <div class="help-id-time" id="help-id-time-range"></div>
            <input type="text" id="help-id-artist" placeholder="Artist name" maxlength="100" />
            <input type="text" id="help-id-title" placeholder="Track title" maxlength="200" />
            <input type="text" id="help-id-name" placeholder="Your name (optional)" maxlength="50" />
            <input type="hidden" id="help-id-set" />
            <input type="hidden" id="help-id-start" />
            <div class="form-buttons">
                <button class="cancel-btn" onclick="closeHelpIdModal()">Cancel</button>
                <button class="submit-btn" onclick="submitHelpId()">Submit</button>
            </div>
            <div class="success-msg" id="help-id-success">Thanks! Your submission has been received.</div>
        </div>
    </div>

    <!-- PROGRAMME + CHAT STACKED -->
    <div id="programme-chat-row">
        <div id="programme-section">
            <h2>PROGRAMME</h2>
            <div id="programme-date"></div>
            <div id="programme-live-message">Currently streaming live. Programme resumes after the live session.</div>
            <div id="programme-list"></div>
        </div>
        <div id="chat-column">
            <h3>CHAT</h3>
            <button id="chat-toggle" onclick="document.getElementById('chat-body').classList.toggle('open'); this.textContent = document.getElementById('chat-body').classList.contains('open') ? 'Hide Chat' : 'Open Chat';">Open Chat</button>
            <a href="https://discord.gg/rrnN2sSYAb" target="_blank" id="discord-btn" style="display: inline-flex; align-items: center; gap: 6px; background: #ff6600; color: #fff; font-family: Oswald, sans-serif; font-size: 11px; font-weight: 400; letter-spacing: 1px; text-transform: uppercase; padding: 8px 14px; text-decoration: none; margin-left: 8px; vertical-align: middle;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                Discord
            </a>
            <div id="chat-body">
                <div id="chat-widget">
                    <div id="chat-header">
                        <span id="chat-online">0 online</span>
                    </div>
                    <div id="chat-messages"></div>
                    <div id="chat-input-row">
                        <input type="text" id="chat-nick" placeholder="Name" maxlength="20" />
                        <input type="text" id="chat-msg" placeholder="Type a message..." maxlength="300" />
                        <button id="chat-send">&#9654;</button>
                    </div>
                </div>
                <div id="chat-discord-link">
                    <a href="https://discord.gg/rrnN2sSYAb" target="_blank">Join our Discord</a>
                </div>
            </div>
        </div>
    </div>

    <!-- FEATURED RESIDENTS -->
    <div id="featured-residents">
        <h2>FEATURED RESIDENTS</h2>
        <div id="residents-list"></div>
    </div>

    <!-- Resident Detail Panel (fullscreen overlay) -->
    <div class="resident-detail-panel" id="resident-detail">
        <button class="detail-close">&times;</button>
        <div class="detail-photo" id="detail-photo"></div>
        <div class="detail-content">
            <div class="detail-label">RESIDENT</div>
            <div class="detail-name" id="detail-name"></div>
            <div class="detail-bio" id="detail-bio"></div>
            <div class="detail-links" id="detail-links"></div>
            <div class="detail-sets" id="detail-sets"></div>
        </div>
    </div>

    <!-- ABOUT SECTION -->
    <div class="w-container" style="margin-top: 40px; margin-bottom: 30px;">
        <h1 class="main-title">RONAUT RADIO</h1>
        <p style="font-size: 14px; font-weight: 400; letter-spacing: 1px; margin: 10px 0 0 0; text-transform: uppercase;">Los Angeles • Vinyl Only • Live Shows</p>
    </div>

    <div class="share-container">
        <button id="btn-share">Share the stream!</button>
    </div>

    <div class="social-links">
        <a href="https://instagram.com/ronautradio" target="_blank" class="w-inline-block">
            <img src="assets/6065dc53271cd689405645e3_social-instagram.svg" loading="lazy" alt="Instagram"/>
        </a>
        <a href="https://facebook.com/ronautradio" target="_blank" class="w-inline-block">
            <img src="assets/6065e3ca47bb418dbc19f3ea_social-facebook.svg" loading="lazy" alt="Facebook"/>
        </a>
        <a href="https://soundcloud.com/ronautradio" target="_blank" class="w-inline-block">
            <img src="assets/6065e41429ff79264e86b0d7_social-soundcloud.svg" loading="lazy" alt="Soundcloud"/>
        </a>
        <a href="https://mixcloud.com/ronautradio" target="_blank" class="w-inline-block">
            <img src="assets/6065e43e39b94578e5cc3ea1_social-mixcloud.svg" loading="lazy" alt="Mixcloud"/>
        </a>
        <a href="https://youtube.com/ronautradio" target="_blank" class="w-inline-block">
            <img src="assets/6065e46287c6313a761f2885_social-youtube.svg" loading="lazy" alt="YouTube"/>
        </a>
        <a href="https://twitter.com/ronautradiola" target="_blank" class="w-inline-block">
            <img src="assets/6065e48787c63189c61f2aab_social-twitter.svg" loading="lazy" alt="Twitter"/>
        </a>
        <a href="https://discord.gg/rrnN2sSYAb" target="_blank" class="w-inline-block">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.6;"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
        </a>
    </div>

    <div class="w-container">
        <p class="paragraph">We are an independent, non-profit online radio station streaming 24/7 from Los Angeles. We broadcast vinyl sets from selectors across Los Angeles and San Diego.</p>
        <p class="paragraph">Ronaut Radio is a platform for local DJs and vinyl enthusiasts to share their sound, build community, and keep underground music moving.</p>
        <p class="paragraph"><strong>If you'd like to be featured or collaborate, <a href="mailto:ronautradio@gmail.com" style="color: #ff6600;">connect with us</a>.</strong></p>
    </div>

    <!-- STAFF PICKS -->
    <div id="staff-picks">
        <h2>STAFF PICKS</h2>
        <div id="genre-filter"></div>
        <div id="picks-grid"></div>
    </div>

    <!-- UPCOMING SHOWS SECTION -->
    <div class="w-container" style="margin-top: 60px; margin-bottom: 40px;">
      <h2 style="font-size: 24px; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px;">UPCOMING SHOWS</h2>
      <div style="text-align: center; margin-bottom: 30px;">
        <a href="https://calendar.google.com/calendar/u/0?cid=cm9uYXV0cmFkaW9AZ21haWwuY29t" target="_blank" style="display: inline-block; background: #000; color: #fff; font-family: Oswald, sans-serif; font-weight: 400; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; padding: 8px 16px; text-decoration: none; margin: 3px;">Subscribe to All</a>
        <a href="https://stream.ronautradio.la/api/calendar.ics" download="ronaut-radio.ics" style="display: inline-block; background: #fff; color: #000; border: 1px solid #000; font-family: Oswald, sans-serif; font-weight: 400; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; padding: 8px 16px; text-decoration: none; margin: 3px;">Download .ics</a>
      </div>
      <div id="upcoming-events" style="max-width: 600px; margin: 0 auto;"></div>
      <p id="no-upcoming" style="text-align: center; font-family: Oswald, sans-serif; font-weight: 300; font-size: 14px; color: #999; display: none;">No upcoming shows scheduled. Check back soon!</p>
    </div>
    
    <div class="section">
        <div id='collection-component-1618238023055'></div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://vjs.zencdn.net/8.5.2/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src='https://unpkg.com/popper.js/dist/umd/popper.min.js'></script>
    <script src='https://unpkg.com/tooltip.js/dist/umd/tooltip.min.js'></script>

    <script>
    // Global HLS instance (needs to be accessible for staff picks player switching)
    var hlsInstance = null;
    var isPlayingPick = false;
    var currentPickTitle = '';
    var currentVodUrl = ''; // Store VOD URL for mini player

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function initHls(video) {
        if (Hls.isSupported()) {
            hlsInstance = new Hls({
                liveSyncDurationCount: 1,       // Buffer only 1 segment (~4s) before playing
                liveMaxLatencyDurationCount: 3, // Tolerate up to 3 segments of latency
                liveDurationInfinity: true,     // Treat live stream as infinite duration
                maxBufferLength: 30,
            });
            hlsInstance.loadSource('https://stream.ronautradio.la/live/hls/stream.m3u8');
            hlsInstance.attachMedia(video);
            hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                video.play().catch(function(e) { console.log("Autoplay prevented", e); });
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = 'https://stream.ronautradio.la/live/hls/stream.m3u8';
            video.addEventListener('loadedmetadata', function() {
                video.play().catch(function(e) { console.log("Autoplay prevented", e); });
            });
        }
    }

    function playPick(url, title, startTime) {
        var video = document.getElementById('ronaut-player');
        var ticker = document.getElementById('ticker');
        var backBtn = document.getElementById('back-to-live');

        // Destroy HLS instance
        if (hlsInstance) {
            hlsInstance.destroy();
            hlsInstance = null;
        }

        video.crossOrigin = 'anonymous';
        video.muted = false;
        video.removeAttribute('muted');
        video.volume = 1;

        var fullUrl = 'https://stream.ronautradio.la' + (url || '');
        var isHls = url && url.indexOf('.m3u8') !== -1;
        currentVodUrl = fullUrl; // Store for mini player

        if (isHls && Hls.isSupported()) {
            // Use HLS.js for m3u8 files
            hlsInstance = new Hls();
            hlsInstance.loadSource(fullUrl);
            hlsInstance.attachMedia(video);
            hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                if (startTime && startTime > 0) {
                    video.currentTime = startTime;
                }
                video.play().catch(function(e) { console.log("Play prevented", e); });
            });
        } else if (isHls && video.canPlayType('application/vnd.apple.mpegurl')) {
            // Native HLS (Safari)
            video.src = fullUrl;
            video.addEventListener('loadedmetadata', function onLoaded() {
                if (startTime && startTime > 0) {
                    video.currentTime = startTime;
                }
                video.removeEventListener('loadedmetadata', onLoaded);
            });
            video.play().catch(function(e) { console.log("Play prevented", e); });
        } else {
            // MP4 direct playback
            video.src = fullUrl;
            video.addEventListener('loadedmetadata', function onLoaded() {
                if (startTime && startTime > 0) {
                    video.currentTime = startTime;
                }
                video.removeEventListener('loadedmetadata', onLoaded);
            });
            video.play().catch(function(e) { console.log("Play prevented", e); });
        }
        // Reset audio context for VOD - real waveform works with MP4
        if (window.RonautAudio && window.RonautAudio.resetForVOD) {
            setTimeout(function() {
                window.RonautAudio.resetForVOD();
            }, 500);
        }

        ticker.textContent = 'Playing: ' + title;
        ticker.style.display = 'block';
        backBtn.style.display = 'block';
        isPlayingPick = true;
        currentPickTitle = title; // Store for mini player

        // Update Media Session for iOS Control Center
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: title,
                artist: 'Ronaut Radio • Staff Pick',
                album: 'Ronaut Radio',
                artwork: [
                    { src: 'https://ronautradio.la/assets/favicon.png', sizes: '512x512', type: 'image/png' }
                ]
            });
            // Re-register action handlers for VOD
            navigator.mediaSession.setActionHandler('play', function() {
                video.muted = false;
                video.volume = 1;
                video.play().catch(function(e) { console.log('Play prevented', e); });
            });
            navigator.mediaSession.setActionHandler('pause', function() {
                video.pause();
            });
            navigator.mediaSession.setActionHandler('seekbackward', function() {
                video.currentTime = Math.max(video.currentTime - 10, 0);
            });
            navigator.mediaSession.setActionHandler('seekforward', function() {
                video.currentTime = Math.min(video.currentTime + 10, video.duration);
            });
            // Enable Control Center scrub bar
            navigator.mediaSession.setActionHandler('seekto', function(details) {
                if (details.seekTime !== undefined) {
                    // Use fastSeek if available (better for scrubbing)
                    if (details.fastSeek && typeof video.fastSeek === 'function') {
                        video.fastSeek(details.seekTime);
                    } else {
                        video.currentTime = details.seekTime;
                    }
                    updatePositionState();
                }
            });
        }

        // Update position state for iOS Control Center scrub bar
        function updatePositionState() {
            if ('mediaSession' in navigator && video.duration && !isNaN(video.duration)) {
                try {
                    navigator.mediaSession.setPositionState({
                        duration: video.duration,
                        playbackRate: video.playbackRate || 1,
                        position: video.currentTime
                    });
                } catch (e) { /* ignore errors */ }
            }
        }

        // Set position state when duration is known
        video.addEventListener('loadedmetadata', function() {
            updatePositionState();
        });

        // Resume playback after seek completes (critical for iOS background)
        var wasPlayingBeforeSeek = false;
        video.addEventListener('seeking', function() {
            wasPlayingBeforeSeek = !video.paused;
        });
        video.addEventListener('seeked', function() {
            updatePositionState();
            // Always try to resume after seek in VOD mode
            if (isPlayingPick) {
                video.muted = false;
                video.volume = 1;
                video.play().then(function() {
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.playbackState = 'playing';
                    }
                }).catch(function(e) { console.log('Resume after seeked', e); });
            }
        });

        // Handle iOS backgrounding - try to keep playing
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden' && isPlayingPick && !video.paused) {
                // Store that we were playing
                video.dataset.wasPlaying = 'true';
            } else if (document.visibilityState === 'visible' && video.dataset.wasPlaying === 'true') {
                video.dataset.wasPlaying = '';
                video.play().catch(function(e) {});
            }
        });

        video.addEventListener('durationchange', function() {
            updatePositionState();
        });

        // Update position state periodically during playback
        var positionInterval = setInterval(function() {
            if (video.paused || video.ended) return;
            updatePositionState();
        }, 1000);

        // Clean up interval when switching back to live
        video.addEventListener('emptied', function() {
            clearInterval(positionInterval);
        }, { once: true });

        // Log VOD play for analytics
        var setName = url.replace('/sets/', '').replace('.mp4', '');
        fetch('https://stream.ronautradio.la/api/vod-play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ set_name: setName })
        }).catch(function(e) { console.log('VOD tracking error', e); });

        // Update mini player title for VOD
        var miniStatus = document.querySelector('#mini-player .mini-status');
        var miniTitle = document.querySelector('#mini-player .mini-title');
        if (miniStatus) miniStatus.textContent = 'PLAYING';
        if (miniTitle) miniTitle.textContent = title;

        // Preload mini video for faster mini player
        var miniVideo = document.getElementById('mini-video');
        if (miniVideo) {
            miniVideo.src = video.src;
            miniVideo.preload = 'auto';
            miniVideo.muted = true; // Mute to allow preload
        }

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function backToLive() {
        var video = document.getElementById('ronaut-player');
        var backBtn = document.getElementById('back-to-live');

        // Re-initialize HLS
        initHls(video);
        backBtn.style.display = 'none';
        isPlayingPick = false;
        currentPickTitle = '';
        currentVodUrl = ''; // Clear VOD URL

        // Switch to demo mode for HLS (real audio analysis often fails with MSE)
        if (window.RonautAudio && window.RonautAudio.setDemoMode) {
            window.RonautAudio.setDemoMode();
        }

        // Re-preload mini video for live stream (mobile)
        if (window.preloadMiniVideo) {
            window.preloadMiniVideo();
        }
    }

    // Help ID Modal
    function openHelpIdModal(setName, startTime, timeRange) {
        document.getElementById('help-id-set').value = setName;
        document.getElementById('help-id-start').value = startTime;
        document.getElementById('help-id-time-range').textContent = 'Time: ' + timeRange;
        document.getElementById('help-id-artist').value = '';
        document.getElementById('help-id-title').value = '';
        document.getElementById('help-id-name').value = localStorage.getItem('ronaut_chat_nick') || '';
        document.getElementById('help-id-success').style.display = 'none';
        document.getElementById('help-id-modal').classList.add('open');
    }

    function closeHelpIdModal() {
        document.getElementById('help-id-modal').classList.remove('open');
    }

    async function submitHelpId() {
        var setName = document.getElementById('help-id-set').value;
        var startTime = parseInt(document.getElementById('help-id-start').value, 10);
        var artist = document.getElementById('help-id-artist').value.trim();
        var title = document.getElementById('help-id-title').value.trim();
        var submittedBy = document.getElementById('help-id-name').value.trim() || 'Anonymous';

        if (!artist || !title) {
            alert('Please enter both artist and track title.');
            return;
        }

        try {
            var res = await fetch('https://stream.ronautradio.la/api/submit-id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    set_name: setName,
                    start_time: startTime,
                    artist: artist,
                    title: title,
                    submitted_by: submittedBy
                })
            });
            var data = await res.json();
            if (data.status === 'ok') {
                document.getElementById('help-id-success').style.display = 'block';
                setTimeout(closeHelpIdModal, 1500);
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (err) {
            alert('Failed to submit. Please try again.');
        }
    }

    // Close modal on backdrop click
    document.getElementById('help-id-modal').addEventListener('click', function(e) {
        if (e.target === this) closeHelpIdModal();
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Media Session API for iOS Control Center / Lock Screen controls
        function updateMediaSession(title, artist) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: title || 'Ronaut Radio',
                    artist: artist || 'Los Angeles • Vinyl Only',
                    album: 'Ronaut Radio',
                    artwork: [
                        { src: 'https://ronautradio.la/assets/favicon.png', sizes: '512x512', type: 'image/png' }
                    ]
                });
            }
        }

        function setupMediaSessionHandlers(video) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', function() {
                    video.play().catch(function(e) { console.log('Play prevented', e); });
                });
                navigator.mediaSession.setActionHandler('pause', function() {
                    video.pause();
                });
                navigator.mediaSession.setActionHandler('stop', function() {
                    video.pause();
                });
            }
        }

        // Player, Now Playing, and Programme
        (function() {
            const video = document.getElementById('ronaut-player');
            const ticker = document.getElementById('ticker');
            const liveBadge = document.getElementById('live-badge');
            const programmeList = document.getElementById('programme-list');
            const programmeLiveMsg = document.getElementById('programme-live-message');

            // Setup Media Session handlers
            setupMediaSessionHandlers(video);

            let currentMode = 'offline';

            function formatTime(unixTimestamp) {
                if (!unixTimestamp || unixTimestamp <= 0) return '';
                var d = new Date(unixTimestamp * 1000);
                var now = new Date();
                var hours = d.getHours().toString().padStart(2, '0');
                var mins = d.getMinutes().toString().padStart(2, '0');
                if (d.toDateString() === now.toDateString()) {
                    return hours + ':' + mins;
                }
                var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return dayNames[d.getDay()] + ' ' + hours + ':' + mins;
            }

            function formatDuration(seconds) {
                if (!seconds || seconds <= 0) return '0:00';
                var h = Math.floor(seconds / 3600);
                var m = Math.floor((seconds % 3600) / 60);
                var s = Math.floor(seconds % 60);
                if (h > 0) {
                    return h + ':' + m.toString().padStart(2, '0') + ':' + s.toString().padStart(2, '0');
                }
                return m + ':' + s.toString().padStart(2, '0');
            }

            async function updateNowPlaying() {
                if (isPlayingPick) return; // Don't override ticker when playing a staff pick
                try {
                    var res = await fetch("https://stream.ronautradio.la/api/now-playing");
                    var data = await res.json();
                    currentMode = data.mode || 'offline';

                    var miniStatus = document.querySelector('#mini-player .mini-status');
                    var miniTitle = document.querySelector('#mini-player .mini-title');
                    var currentTrackEl = document.getElementById('current-track');

                    if (currentMode === 'live') {
                        liveBadge.classList.add('active');
                        liveBadge.style.display = 'flex';
                        ticker.textContent = 'LIVE BROADCAST';
                        ticker.style.display = 'block';
                        if (currentTrackEl) currentTrackEl.style.display = 'none';
                        if (miniStatus) miniStatus.textContent = 'LIVE';
                        if (miniTitle) miniTitle.textContent = 'Live Broadcast';
                        updateMediaSession('Live Broadcast', 'Ronaut Radio');
                    } else {
                        liveBadge.classList.remove('active');
                        liveBadge.style.display = 'none';
                        if (data.now_playing && data.now_playing !== 'Offline') {
                            ticker.textContent = 'Now Playing: ' + data.now_playing;
                            ticker.style.display = 'block';
                            if (miniStatus) miniStatus.textContent = 'NOW PLAYING';
                            if (miniTitle) miniTitle.textContent = data.now_playing;
                            updateMediaSession(data.now_playing, 'Ronaut Radio');
                        } else {
                            ticker.textContent = 'Stream offline';
                            ticker.style.display = 'block';
                            if (miniStatus) miniStatus.textContent = 'OFFLINE';
                            if (miniTitle) miniTitle.textContent = 'Stream offline';
                            updateMediaSession('Stream Offline', 'Ronaut Radio');
                        }
                        // Show current track (artist/title within the set)
                        if (currentTrackEl) {
                            var ct = data.current_track;
                            if (ct && ct.title) {
                                var artist = ct.artists && ct.artists.length > 0 ? ct.artists[0] : '';
                                currentTrackEl.textContent = artist ? '♪ ' + artist + ' — ' + ct.title : '♪ ' + ct.title;
                                currentTrackEl.style.display = 'block';
                            } else {
                                currentTrackEl.style.display = 'none';
                            }
                        }
                    }
                } catch (err) {
                    console.error("Failed to fetch now playing:", err);
                    ticker.textContent = 'Error loading track info.';
                    ticker.style.display = 'block';
                }
            }

            async function updateProgramme() {
                var programmeDate = document.getElementById('programme-date');
                if (programmeDate) {
                    var now = new Date();
                    var dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
                    var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                    programmeDate.textContent = dayNames[now.getDay()] + ', ' + monthNames[now.getMonth()] + ' ' + now.getDate() + ', ' + now.getFullYear();
                }

                if (currentMode !== 'auto') {
                    programmeList.innerHTML = '';
                    programmeLiveMsg.style.display = currentMode === 'live' ? 'block' : 'none';
                    return;
                }
                programmeLiveMsg.style.display = 'none';

                try {
                    var res = await fetch("https://stream.ronautradio.la/api/programme?count=9&recent=2");
                    var data = await res.json();

                    if (!data.current && (!data.upcoming || data.upcoming.length === 0)) {
                        programmeList.innerHTML = '<div class="programme-item"><span class="track-name">No programme data available</span></div>';
                        return;
                    }

                    var html = '';
                    // Recent tracks (already played)
                    if (data.recent && data.recent.length > 0) {
                        for (var r = 0; r < data.recent.length; r++) {
                            var recent = data.recent[r];
                            var recentTime = formatTime(recent.ended_at - recent.duration);
                            html += '<div class="programme-item programme-past">';
                            html += '<span class="track-name">' + escapeHtml(recent.display_name) + '</span>';
                            html += '<span class="track-time">' + recentTime + '</span>';
                            html += '</div>';
                        }
                    }
                    // Current track with progress line
                    if (data.current) {
                        var elapsed = Math.floor(Date.now() / 1000) - data.current.started_at;
                        var duration = data.current.duration || 0;
                        if (elapsed < 0) elapsed = 0;
                        if (elapsed > duration && duration > 0) elapsed = duration;
                        var progressPct = duration > 0 ? Math.min(100, (elapsed / duration) * 100) : 0;

                        html += '<div class="programme-item now-playing">';
                        if (duration > 0) {
                            html += '<div class="progress-line" style="left:' + progressPct.toFixed(1) + '%"></div>';
                        }
                        html += '<span class="track-name"><span class="now-playing-dot"></span>' + escapeHtml(data.current.display_name) + '</span>';
                        html += '<span class="track-time">NOW</span>';
                        html += '</div>';
                    }
                    // Upcoming tracks
                    if (data.upcoming) {
                        for (var i = 0; i < data.upcoming.length; i++) {
                            var track = data.upcoming[i];
                            var timeStr = formatTime(track.estimated_start);
                            html += '<div class="programme-item">';
                            html += '<span class="track-name">' + escapeHtml(track.display_name) + '</span>';
                            html += '<span class="track-time">' + timeStr + '</span>';
                            html += '</div>';
                        }
                    }
                    programmeList.innerHTML = html;
                } catch (err) {
                    console.error("Failed to fetch programme:", err);
                }
            }

            // Initial calls — programme needs currentMode from now-playing first
            updateNowPlaying().then(function() {
                updateProgramme();
            });

            // Poll: now-playing every 10s, programme every 30s
            setInterval(updateNowPlaying, 10000);
            setInterval(updateProgramme, 30000);

            // Listener count polling
            var listenerCountEl = document.getElementById('listener-count');
            async function updateListenerCount() {
                if (!listenerCountEl) return;
                try {
                    var res = await fetch('https://stream.ronautradio.la/api/listeners');
                    var data = await res.json();
                    if (data.listeners !== null && data.listeners > 0) {
                        listenerCountEl.textContent = '● ' + data.listeners + ' listening';
                        listenerCountEl.style.display = 'block';
                    } else {
                        listenerCountEl.style.display = 'none';
                    }
                } catch (err) {
                    listenerCountEl.style.display = 'none';
                }
            }
            updateListenerCount();
            setInterval(updateListenerCount, 30000);

            // Cast / AirPlay button
            (function() {
                var video = document.getElementById('ronaut-player');
                var castBtn = document.getElementById('cast-btn');
                var miniCastBtn = document.getElementById('mini-cast-btn');

                function showCastBtns() {
                    if (castBtn) castBtn.style.display = 'block';
                    if (miniCastBtn) miniCastBtn.style.display = 'block';
                }

                function triggerCast() {
                    // AirPlay (Safari / iOS)
                    if (video.webkitShowPlaybackTargetPicker) {
                        video.webkitShowPlaybackTargetPicker();
                        return;
                    }
                    // Chromecast / Remote Playback API (Chrome)
                    if (video.remote && video.remote.prompt) {
                        video.remote.prompt().catch(function() {});
                        return;
                    }
                }

                // AirPlay availability (Safari)
                if (window.WebKitPlaybackTargetAvailabilityEvent) {
                    video.addEventListener('webkitplaybacktargetavailabilitychanged', function(e) {
                        if (e.availability === 'available') showCastBtns();
                    });
                }

                // Remote Playback API availability (Chrome / Chromecast)
                if (video.remote) {
                    video.remote.watchAvailability(function(available) {
                        if (available) showCastBtns();
                    }).catch(function() {});

                    video.remote.addEventListener('connecting', function() {
                        if (castBtn) castBtn.classList.add('casting');
                        if (miniCastBtn) miniCastBtn.style.opacity = '1';
                    });
                    video.remote.addEventListener('connect', function() {
                        if (castBtn) castBtn.classList.add('casting');
                    });
                    video.remote.addEventListener('disconnect', function() {
                        if (castBtn) castBtn.classList.remove('casting');
                        if (miniCastBtn) miniCastBtn.style.opacity = '';
                    });
                }

                if (castBtn) castBtn.addEventListener('click', triggerCast);
                if (miniCastBtn) miniCastBtn.addEventListener('click', triggerCast);
            })();

            // Mini Player - show when main player scrolls out of view
            (function() {
                var miniPlayer = document.getElementById('mini-player');
                var playerContainer = document.getElementById('player-container');
                var video = document.getElementById('ronaut-player');
                var miniVideo = document.getElementById('mini-video');
                var miniPlayBtn = document.getElementById('mini-play-btn');
                var miniMuteBtn = document.getElementById('mini-mute-btn');
                var miniActive = false;

                function updateMiniPlayerButtons() {
                    if (!video) return;
                    // Play/Pause icon
                    if (video.paused) {
                        miniPlayBtn.innerHTML = '<svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>';
                    } else {
                        miniPlayBtn.innerHTML = '<svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
                    }
                    // Mute icon
                    if (video.muted) {
                        miniMuteBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>';
                    } else {
                        miniMuteBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>';
                    }
                }

                // Detect mobile (no captureStream support)
                var isMobile = !video.captureStream && !video.mozCaptureStream;
                var miniHlsInstance = null;
                var miniPreloaded = false;

                // Pre-load mini video on mobile for instant display
                function preloadMiniVideo() {
                    if (!isMobile || miniPreloaded || isPlayingPick) return;
                    miniPreloaded = true;

                    if (Hls.isSupported()) {
                        miniHlsInstance = new Hls();
                        miniHlsInstance.loadSource('https://stream.ronautradio.la/live/hls/stream.m3u8');
                        miniHlsInstance.attachMedia(miniVideo);
                        miniHlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                            miniVideo.muted = true;
                            miniVideo.play().catch(function(e) {});
                        });
                    } else if (miniVideo.canPlayType('application/vnd.apple.mpegurl')) {
                        // Native HLS (iOS Safari)
                        miniVideo.src = 'https://stream.ronautradio.la/live/hls/stream.m3u8';
                        miniVideo.muted = true;
                        miniVideo.play().catch(function(e) {});
                    }
                }

                // Pre-load after main video starts (give it a moment)
                setTimeout(preloadMiniVideo, 2000);

                // Expose for backToLive to re-trigger preload
                window.preloadMiniVideo = function() {
                    miniPreloaded = false;
                    setTimeout(preloadMiniVideo, 1000);
                };

                function initMiniVideo() {
                    if (miniActive) return;
                    miniActive = true;

                    // Desktop: use captureStream for instant mirroring
                    if (video.captureStream) {
                        try {
                            miniVideo.srcObject = video.captureStream();
                            miniVideo.play().catch(function(e) {});
                            return;
                        } catch (e) {}
                    }

                    if (video.mozCaptureStream) {
                        try {
                            miniVideo.srcObject = video.mozCaptureStream();
                            miniVideo.play().catch(function(e) {});
                            return;
                        } catch (e) {}
                    }

                    // Mobile: mini video is already preloaded and playing for live
                    // For VOD, we need to load the VOD source
                    if (isPlayingPick && currentVodUrl) {
                        // Destroy live HLS instance
                        if (miniHlsInstance) {
                            miniHlsInstance.destroy();
                            miniHlsInstance = null;
                        }

                        var isVodHls = currentVodUrl.indexOf('.m3u8') !== -1;

                        if (isVodHls && Hls.isSupported()) {
                            // Use HLS.js for VOD
                            miniHlsInstance = new Hls();
                            miniHlsInstance.loadSource(currentVodUrl);
                            miniHlsInstance.attachMedia(miniVideo);
                            miniHlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                                miniVideo.currentTime = video.currentTime;
                                miniVideo.muted = true;
                                miniVideo.play().catch(function(e) {});
                            });
                        } else {
                            // Native HLS (iOS Safari) or MP4
                            miniVideo.src = currentVodUrl;
                            miniVideo.addEventListener('loadedmetadata', function onLoaded() {
                                miniVideo.currentTime = video.currentTime;
                                miniVideo.removeEventListener('loadedmetadata', onLoaded);
                            });
                            miniVideo.muted = true;
                            miniVideo.play().catch(function(e) {});
                        }
                    }
                    // For live stream, mini video is already playing from preload
                }

                function hideMiniVideo() {
                    miniActive = false;
                    // On mobile, don't destroy - keep preloaded for next time
                    if (!isMobile) {
                        miniVideo.srcObject = null;
                        miniVideo.src = '';
                    }
                    // If we switched to VOD, reload live stream for next time
                    if (isMobile && isPlayingPick) {
                        miniPreloaded = false;
                    }
                }

                // Scroll listener
                var lastScrollY = 0;
                var ticking = false;
                var wasVisible = false;
                window.addEventListener('scroll', function() {
                    lastScrollY = window.scrollY;
                    if (!ticking) {
                        window.requestAnimationFrame(function() {
                            var rect = playerContainer.getBoundingClientRect();
                            var playerHidden = rect.bottom < 100;
                            if (playerHidden) {
                                miniPlayer.classList.add('visible');
                                if (!wasVisible) {
                                    initMiniVideo();
                                    wasVisible = true;
                                }
                            } else {
                                miniPlayer.classList.remove('visible');
                                if (wasVisible) {
                                    hideMiniVideo();
                                    wasVisible = false;
                                }
                            }
                            ticking = false;
                        });
                        ticking = true;
                    }
                });

                // Mini player controls
                miniPlayBtn.addEventListener('click', function() {
                    if (video.paused) {
                        video.play().catch(function(e) { console.log('Play prevented', e); });
                    } else {
                        video.pause();
                    }
                    updateMiniPlayerButtons();
                });

                miniMuteBtn.addEventListener('click', function() {
                    video.muted = !video.muted;
                    updateMiniPlayerButtons();
                });

                // Update buttons when video state changes
                video.addEventListener('play', function() {
                    updateMiniPlayerButtons();
                    // Sync miniVideo play state for VOD
                    if (isPlayingPick && miniVideo.src && miniVideo.paused) {
                        miniVideo.play().catch(function(e) {});
                    }
                });
                video.addEventListener('pause', function() {
                    updateMiniPlayerButtons();
                    // Sync miniVideo pause state for VOD
                    if (isPlayingPick && miniVideo.src && !miniVideo.paused) {
                        miniVideo.pause();
                    }
                });
                video.addEventListener('volumechange', updateMiniPlayerButtons);

                // Sync mini video time with main video for VOD playback
                video.addEventListener('timeupdate', function() {
                    if (isPlayingPick && wasVisible && miniVideo.src) {
                        // Sync if more than 2 seconds apart
                        if (Math.abs(video.currentTime - miniVideo.currentTime) > 2) {
                            miniVideo.currentTime = video.currentTime;
                        }
                    }
                });

                // Click mini player to scroll to main player
                miniPlayer.querySelector('.mini-info').addEventListener('click', function() {
                    playerContainer.scrollIntoView({ behavior: 'smooth' });
                });

                // Click mini video to scroll to main player
                miniVideo.addEventListener('click', function() {
                    playerContainer.scrollIntoView({ behavior: 'smooth' });
                });

            })();

            // Initialize HLS Player
            video.crossOrigin = 'anonymous';
            initHls(video);

            // Audio-reactive visuals
            (function() {
                var audioCtx = null;
                var analyser = null;
                var dataArray = null;
                var timeDataArray = null;
                var edgePulse = document.getElementById('edge-pulse');
                var energyBar = document.getElementById('energy-bar');
                var waveCanvas = document.getElementById('waveform-canvas');
                var waveCtx = waveCanvas.getContext('2d');
                var isAudioConnected = false;
                var audioConnectionFailed = true; // Default to demo mode for HLS (VOD will enable real audio)
                var smoothedWaveform = null; // For temporal smoothing
                var demoPhase = 0; // For demo mode animation

                // Resize waveform canvas
                function resizeWaveCanvas() {
                    var container = document.getElementById('waveform-container');
                    if (!container) return;
                    var rect = container.getBoundingClientRect();
                    var dpr = window.devicePixelRatio || 1;
                    // Use rect dimensions which work better on mobile
                    var w = rect.width || container.offsetWidth || 280;
                    var h = rect.height || container.offsetHeight || 70;
                    waveCanvas.width = w * dpr;
                    waveCanvas.height = h * dpr;
                    waveCanvas.style.width = w + 'px';
                    waveCanvas.style.height = h + 'px';
                    waveCtx.setTransform(1, 0, 0, 1, 0, 0);
                    waveCtx.scale(dpr, dpr);
                }
                // Initial resize after a short delay (for mobile layout)
                setTimeout(resizeWaveCanvas, 100);
                window.addEventListener('resize', resizeWaveCanvas);
                window.addEventListener('orientationchange', function() {
                    setTimeout(resizeWaveCanvas, 200);
                });

                // Generate demo waveform data (when real audio isn't available)
                function generateDemoWaveform(numPoints) {
                    var points = [];
                    demoPhase += 0.02;
                    for (var i = 0; i < numPoints; i++) {
                        // Combine multiple sine waves for organic feel
                        var x = i / numPoints;
                        var v = Math.sin(x * Math.PI * 4 + demoPhase) * 0.3;
                        v += Math.sin(x * Math.PI * 2 + demoPhase * 0.7) * 0.2;
                        v += Math.sin(x * Math.PI * 7 + demoPhase * 1.3) * 0.15;
                        v += (Math.random() - 0.5) * 0.05; // Subtle noise
                        points.push(v);
                    }
                    return points;
                }

                // Draw AM-style waveform - smooth, flowing, iconic
                function drawWaveform() {
                    var container = document.getElementById('waveform-container');
                    if (!container) return;
                    var rect = container.getBoundingClientRect();
                    var w = rect.width || 280;
                    var h = rect.height || 70;
                    if (w < 10 || h < 10) return; // Don't draw if too small
                    var centerY = h / 2;

                    // Clear canvas
                    waveCtx.clearRect(0, 0, w, h);

                    var numPoints = 32; // Fewer points = smoother
                    var rawPoints = [];

                    // Use real audio data if available, otherwise use demo mode
                    if (analyser && timeDataArray && isAudioConnected && !audioConnectionFailed) {
                        analyser.getByteTimeDomainData(timeDataArray);
                        var blockSize = Math.floor(timeDataArray.length / numPoints);

                        for (var i = 0; i < numPoints; i++) {
                            var sum = 0;
                            var start = i * blockSize;
                            // Average the block for smoothing
                            for (var j = 0; j < blockSize; j++) {
                                sum += timeDataArray[start + j];
                            }
                            var avg = sum / blockSize;
                            var v = (avg - 128) / 128; // Normalize to -1 to 1
                            rawPoints.push(v);
                        }
                    } else {
                        // Demo mode: generate synthetic waveform
                        rawPoints = generateDemoWaveform(numPoints);
                    }

                    // Temporal smoothing - blend with previous frame
                    if (!smoothedWaveform) {
                        smoothedWaveform = rawPoints.slice();
                    } else {
                        var smoothFactor = 0.7; // Higher = smoother/slower
                        for (var s = 0; s < rawPoints.length; s++) {
                            smoothedWaveform[s] = smoothedWaveform[s] * smoothFactor + rawPoints[s] * (1 - smoothFactor);
                        }
                    }

                    // Build points for drawing
                    var points = [];
                    var sliceWidth = w / (smoothedWaveform.length - 1);
                    for (var p = 0; p < smoothedWaveform.length; p++) {
                        var x = p * sliceWidth;
                        var y = centerY + smoothedWaveform[p] * (h * 0.6); // Scale amplitude (+50%)
                        points.push({ x: x, y: y });
                    }

                    // Draw filled area with gradient (AM style)
                    var gradient = waveCtx.createLinearGradient(0, 0, 0, h);
                    gradient.addColorStop(0, 'rgba(255, 255, 255, 0)');
                    gradient.addColorStop(0.3, 'rgba(255, 255, 255, 0.15)');
                    gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.25)');
                    gradient.addColorStop(0.7, 'rgba(255, 255, 255, 0.15)');
                    gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

                    // Draw smooth curve using cardinal spline
                    waveCtx.beginPath();
                    waveCtx.moveTo(0, centerY);

                    // Catmull-Rom spline for ultra-smooth curves
                    for (var c = 0; c < points.length - 1; c++) {
                        var p0 = points[c - 1] || points[c];
                        var p1 = points[c];
                        var p2 = points[c + 1];
                        var p3 = points[c + 2] || p2;

                        for (var t = 0; t <= 1; t += 0.1) {
                            var t2 = t * t;
                            var t3 = t2 * t;
                            var px = 0.5 * ((2 * p1.x) + (-p0.x + p2.x) * t + (2 * p0.x - 5 * p1.x + 4 * p2.x - p3.x) * t2 + (-p0.x + 3 * p1.x - 3 * p2.x + p3.x) * t3);
                            var py = 0.5 * ((2 * p1.y) + (-p0.y + p2.y) * t + (2 * p0.y - 5 * p1.y + 4 * p2.y - p3.y) * t2 + (-p0.y + 3 * p1.y - 3 * p2.y + p3.y) * t3);
                            waveCtx.lineTo(px, py);
                        }
                    }

                    // Complete the fill path
                    waveCtx.lineTo(w, centerY);
                    waveCtx.lineTo(w, h);
                    waveCtx.lineTo(0, h);
                    waveCtx.closePath();
                    waveCtx.fillStyle = gradient;
                    waveCtx.fill();

                    // Draw the main line (AM white line)
                    waveCtx.beginPath();
                    for (var d = 0; d < points.length - 1; d++) {
                        var dp0 = points[d - 1] || points[d];
                        var dp1 = points[d];
                        var dp2 = points[d + 1];
                        var dp3 = points[d + 2] || dp2;

                        for (var dt = 0; dt <= 1; dt += 0.1) {
                            var dt2 = dt * dt;
                            var dt3 = dt2 * dt;
                            var dpx = 0.5 * ((2 * dp1.x) + (-dp0.x + dp2.x) * dt + (2 * dp0.x - 5 * dp1.x + 4 * dp2.x - dp3.x) * dt2 + (-dp0.x + 3 * dp1.x - 3 * dp2.x + dp3.x) * dt3);
                            var dpy = 0.5 * ((2 * dp1.y) + (-dp0.y + dp2.y) * dt + (2 * dp0.y - 5 * dp1.y + 4 * dp2.y - dp3.y) * dt2 + (-dp0.y + 3 * dp1.y - 3 * dp2.y + dp3.y) * dt3);
                            if (d === 0 && dt === 0) {
                                waveCtx.moveTo(dpx, dpy);
                            } else {
                                waveCtx.lineTo(dpx, dpy);
                            }
                        }
                    }

                    // Glow effect
                    waveCtx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                    waveCtx.lineWidth = 6;
                    waveCtx.lineCap = 'round';
                    waveCtx.stroke();

                    // Main white line
                    waveCtx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
                    waveCtx.lineWidth = 2;
                    waveCtx.stroke();
                }

                // Connect audio for analysis (called on user interaction)
                function connectAudio() {
                    if (isAudioConnected || audioConnectionFailed || !video) return;
                    try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        var source = audioCtx.createMediaElementSource(video);
                        analyser = audioCtx.createAnalyser();
                        analyser.fftSize = 2048; // Higher for smoother waveform
                        analyser.smoothingTimeConstant = 0.9;
                        source.connect(analyser);
                        analyser.connect(audioCtx.destination);
                        dataArray = new Uint8Array(analyser.frequencyBinCount);
                        timeDataArray = new Uint8Array(analyser.fftSize);
                        isAudioConnected = true;
                        console.log('Audio analysis connected');
                    } catch (e) {
                        console.log('Audio analysis not available (using demo mode):', e.message);
                        audioConnectionFailed = true;
                        // Demo mode will be used automatically
                    }
                }

                // Animation loop
                function animate() {
                    requestAnimationFrame(animate);

                    // Draw waveform (works in both real and demo mode)
                    drawWaveform();

                    // Calculate energy for edge pulse and energy bar
                    var bass = 0;
                    var energy = 0;

                    if (analyser && dataArray && isAudioConnected && !audioConnectionFailed) {
                        analyser.getByteFrequencyData(dataArray);

                        // Calculate bass energy (lower frequencies)
                        var bassCount = Math.floor(dataArray.length * 0.15); // Lower 15% of frequencies
                        for (var i = 0; i < bassCount; i++) {
                            bass += dataArray[i];
                        }
                        bass = bass / bassCount / 255; // Normalize 0-1

                        // Calculate overall energy
                        var total = 0;
                        for (var j = 0; j < dataArray.length; j++) {
                            total += dataArray[j];
                        }
                        energy = total / dataArray.length / 255; // Normalize 0-1
                    } else {
                        // Demo mode: generate synthetic energy
                        bass = 0.3 + Math.sin(demoPhase * 2) * 0.15 + Math.random() * 0.05;
                        energy = 0.4 + Math.sin(demoPhase * 1.5) * 0.2 + Math.random() * 0.05;
                    }

                    // Edge pulse based on bass (subtle)
                    var pulseIntensity = Math.pow(bass, 1.5) * 0.12; // Max ~12% opacity
                    edgePulse.style.boxShadow = 'inset 0 0 ' + (40 + bass * 40) + 'px rgba(255, 255, 255, ' + pulseIntensity + ')';

                    // Energy bar
                    energyBar.style.width = (energy * 100) + '%';
                }

                // Start on user interaction (autoplay policy)
                function activateAudio() {
                    connectAudio();
                    if (audioCtx && audioCtx.state === 'suspended') {
                        audioCtx.resume().then(function() {
                            console.log('AudioContext resumed');
                        }).catch(function(e) {
                            console.log('Failed to resume AudioContext:', e.message);
                        });
                    }
                    resizeWaveCanvas(); // Ensure canvas is sized
                }

                // Expose a safe hook for staff-pick switching
                window.RonautAudio = {
                    activate: activateAudio,
                    resetForVOD: function() {
                        // For VOD playback, use real audio analysis
                        // MediaElementSource persists across src changes, just resume context
                        audioConnectionFailed = false;
                        if (audioCtx && audioCtx.state === 'suspended') {
                            audioCtx.resume();
                        }
                        // Try to connect if not yet connected
                        if (!isAudioConnected) {
                            setTimeout(connectAudio, 300);
                        }
                    },
                    // For HLS, we use demo mode (real analysis often fails with MSE)
                    setDemoMode: function() {
                        audioConnectionFailed = true;
                    },
                    // Legacy alias
                    resetAndRetry: function() {
                        this.resetForVOD();
                    }
                };

                video.addEventListener('play', activateAudio);
                video.addEventListener('playing', activateAudio);
                video.addEventListener('volumechange', function() {
                    // Try to connect when user unmutes
                    if (!video.muted && !isAudioConnected && !audioConnectionFailed) {
                        activateAudio();
                    }
                });

                // Click and touch for mobile
                document.addEventListener('click', activateAudio, { once: true });
                document.addEventListener('touchstart', activateAudio, { once: true });
                document.addEventListener('touchend', activateAudio, { once: true });

                animate();
            })();
        })();

        // Featured Residents - Simple list with detail panel
        (function() {
            var residentsList = document.getElementById('residents-list');
            var detailPanel = document.getElementById('resident-detail');
            var detailClose = detailPanel.querySelector('.detail-close');
            var residentsData = [];

            async function loadResidents() {
                try {
                    var res = await fetch('https://stream.ronautradio.la/api/residents');
                    var data = await res.json();
                    if (!data.residents || data.residents.length === 0) {
                        document.getElementById('featured-residents').style.display = 'none';
                        return;
                    }

                    residentsData = data.residents;

                    var html = '';
                    for (var i = 0; i < residentsData.length; i++) {
                        var r = residentsData[i];
                        html += '<div class="resident-row" data-index="' + i + '">';
                        html += '<img src="https://stream.ronautradio.la' + r.photo + '" alt="' + escapeHtml(r.name) + '" onerror="this.src=\'https://stream.ronautradio.la/residents/logo.png\'" />';
                        html += '<span class="name">' + escapeHtml(r.name) + '</span>';
                        html += '<span class="arrow">&#8250;</span>';
                        html += '</div>';
                    }
                    residentsList.innerHTML = html;

                    // Click to open detail panel
                    var rows = residentsList.querySelectorAll('.resident-row');
                    rows.forEach(function(row) {
                        row.addEventListener('click', function() {
                            var idx = parseInt(this.getAttribute('data-index'));
                            openDetail(idx);
                        });
                    });

                } catch (err) {
                    console.error('Failed to load residents:', err);
                    document.getElementById('featured-residents').style.display = 'none';
                }
            }

            function openDetail(idx) {
                var r = residentsData[idx];
                var photoUrl = 'https://stream.ronautradio.la' + r.photo;
                var fallbackUrl = 'https://stream.ronautradio.la/residents/logo.png';
                var detailPhoto = document.getElementById('detail-photo');

                // Try to load image, use fallback if fails
                var img = new Image();
                img.onload = function() {
                    detailPhoto.style.backgroundImage = 'url(' + photoUrl + ')';
                };
                img.onerror = function() {
                    detailPhoto.style.backgroundImage = 'url(' + fallbackUrl + ')';
                };
                img.src = photoUrl;
                document.getElementById('detail-name').textContent = r.name;
                document.getElementById('detail-bio').textContent = r.bio || '';

                // Social links
                var linksHtml = '';
                if (r.social) {
                    if (r.social.instagram) linksHtml += '<a href="' + r.social.instagram + '" target="_blank">Instagram</a>';
                    if (r.social.soundcloud) linksHtml += '<a href="' + r.social.soundcloud + '" target="_blank">Soundcloud</a>';
                    if (r.social.ra) linksHtml += '<a href="' + r.social.ra + '" target="_blank">Resident Advisor</a>';
                    if (r.social.mixcloud) linksHtml += '<a href="' + r.social.mixcloud + '" target="_blank">Mixcloud</a>';
                    if (r.social.bandcamp) linksHtml += '<a href="' + r.social.bandcamp + '" target="_blank">Bandcamp</a>';
                    if (r.social.spotify) linksHtml += '<a href="' + r.social.spotify + '" target="_blank">Spotify</a>';
                    if (r.social.linktree) linksHtml += '<a href="' + r.social.linktree + '" target="_blank">Linktree</a>';
                    if (r.social.website) linksHtml += '<a href="' + r.social.website + '" target="_blank">Website</a>';
                }
                document.getElementById('detail-links').innerHTML = linksHtml;

                // Sets
                var setsHtml = '';
                if (r.sets && r.sets.length > 0) {
                    setsHtml += '<div class="detail-sets-title">Listen to their sets</div>';
                    for (var j = 0; j < r.sets.length; j++) {
                        var setFile = r.sets[j];
                        var setName = setFile.replace('.mp4', '');
                        setsHtml += '<span class="detail-set-link" data-url="/sets/' + setFile + '" data-title="' + escapeHtml(setName) + '">' + escapeHtml(setName) + '</span>';
                    }
                }
                document.getElementById('detail-sets').innerHTML = setsHtml;

                // Add click listeners for set links
                var setLinks = document.querySelectorAll('#detail-sets .detail-set-link');
                setLinks.forEach(function(link) {
                    link.addEventListener('click', function() {
                        var url = this.getAttribute('data-url');
                        var title = this.getAttribute('data-title');
                        closeDetail();
                        if (typeof playPick === 'function') {
                            playPick(url, title);
                        }
                    });
                });

                detailPanel.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeDetail() {
                detailPanel.classList.remove('active');
                document.body.style.overflow = '';
            }

            detailClose.addEventListener('click', closeDetail);

            // Close on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && detailPanel.classList.contains('active')) {
                    closeDetail();
                }
            });

            loadResidents();
        })();

        // Staff Picks
        (function() {
            var picksGrid = document.getElementById('picks-grid');
            var genreFilter = document.getElementById('genre-filter');
            var setsData = {};  // Store set data for seek functionality
            function encodePickPath(path) {
                if (!path) return '';
                // Encode only the filename segment to preserve leading /sets/
                var parts = path.split('/');
                if (parts.length > 0) {
                    parts[parts.length - 1] = encodeURIComponent(parts[parts.length - 1]);
                }
                return parts.join('/');
            }
            function displayPickTitle(pick) {
                var filenameTitle = pick.filename ? pick.filename.replace(/\.mp4$/i, '') : '';
                if (filenameTitle && /^Ronaut\[\d+\]/i.test(filenameTitle)) {
                    return filenameTitle;
                }
                return pick.title || filenameTitle || 'Untitled';
            }

            async function loadStaffPicks() {
                try {
                    var res = await fetch('https://stream.ronautradio.la/api/sets');
                    var data = await res.json();
                    if (!data.sets || data.sets.length === 0) return;

                    var html = '';
                    for (var i = 0; i < data.sets.length; i++) {
                        var pick = data.sets[i];
                        var encodedUrl = encodePickPath(pick.url);
                        var title = displayPickTitle(pick);
                        setsData[encodedUrl] = pick;

                        var genreAttr = pick.genres && pick.genres.length > 0 ? pick.genres.join(',').toLowerCase() : '';
                        html += '<div class="pick-card" data-url="' + encodedUrl + '" data-title="' + escapeHtml(title) + '" data-genres="' + escapeHtml(genreAttr) + '">';
                        html += '<img src="' + encodePickPath('https://stream.ronautradio.la' + pick.thumbnail) + '" alt="' + escapeHtml(title) + '" loading="lazy" />';
                        html += '<div class="pick-title">' + escapeHtml(title) + '</div>';
                        if (pick.description) {
                            html += '<div class="pick-desc">' + escapeHtml(pick.description) + '</div>';
                        }
                        // Genres/vibes
                        if (pick.genres && pick.genres.length > 0) {
                            html += '<div class="pick-genres">' + pick.genres.map(escapeHtml).join(' · ') + '</div>';
                        }
                        // Tracklist toggle (includes identified + unidentified)
                        var hasTracklist = (pick.tracklist && pick.tracklist.length > 0);
                        var hasUnidentified = (pick.unidentified && pick.unidentified.length > 0);
                        if (hasTracklist || hasUnidentified) {
                            var totalCount = (pick.tracklist ? pick.tracklist.length : 0);
                            var unidCount = pick.unidentified ? pick.unidentified.length : 0;
                            var label = totalCount > 0 ? 'Tracklist (' + totalCount + ')' : '';
                            if (unidCount > 0) {
                                label += (label ? ' + ' : '') + unidCount + ' unidentified';
                            }
                            html += '<div class="pick-tracklist-toggle" data-url="' + encodedUrl + '">' + label + '</div>';
                            html += '<div class="pick-tracklist" id="tracklist-' + i + '">';
                            // Merge and sort by start_time
                            var allTracks = [];
                            if (pick.tracklist) {
                                for (var t = 0; t < pick.tracklist.length; t++) {
                                    allTracks.push({type: 'identified', data: pick.tracklist[t]});
                                }
                            }
                            if (pick.unidentified) {
                                for (var u = 0; u < pick.unidentified.length; u++) {
                                    allTracks.push({type: 'unidentified', data: pick.unidentified[u]});
                                }
                            }
                            allTracks.sort(function(a, b) { return a.data.start_time - b.data.start_time; });

                            for (var at = 0; at < allTracks.length; at++) {
                                var item = allTracks[at];
                                if (item.type === 'identified') {
                                    var track = item.data;
                                    var artist = track.artists && track.artists.length > 0 ? track.artists[0] : 'Unknown';
                                    html += '<div class="track">';
                                    html += '<span class="track-time" data-url="' + encodedUrl + '" data-time="' + track.start_time + '">' + track.start_time_formatted + '</span>';
                                    html += escapeHtml(artist) + ' - ' + escapeHtml(track.title);
                                    html += '</div>';
                                } else {
                                    var unid = item.data;
                                    var timeRange = unid.start_time_formatted + ' - ' + unid.end_time_formatted;
                                    var setName = pick.filename.replace('.mp4', '');
                                    html += '<div class="track unidentified">';
                                    html += '<span class="track-time" data-url="' + encodedUrl + '" data-time="' + unid.start_time + '">' + timeRange + '</span>';
                                    html += escapeHtml(unid.title) + ' <span class="help-id" data-set="' + escapeHtml(setName) + '" data-start="' + unid.start_time + '" data-range="' + timeRange + '">[Help ID]</span>';
                                    html += '</div>';
                                }
                            }
                            html += '</div>';
                        }
                        html += '</div>';
                    }
                    picksGrid.innerHTML = html;

                    // Build genre filter
                    var allGenres = new Set();
                    for (var gi = 0; gi < data.sets.length; gi++) {
                        var gs = data.sets[gi].genres || [];
                        for (var gj = 0; gj < gs.length; gj++) {
                            allGenres.add(gs[gj].toLowerCase());
                        }
                    }
                    if (allGenres.size > 0 && genreFilter) {
                        var sortedGenres = Array.from(allGenres).sort();
                        var filterHtml = '<button class="genre-btn active" data-genre="all">ALL</button>';
                        for (var gk = 0; gk < sortedGenres.length; gk++) {
                            filterHtml += '<button class="genre-btn" data-genre="' + escapeHtml(sortedGenres[gk]) + '">' + escapeHtml(sortedGenres[gk]) + '</button>';
                        }
                        genreFilter.innerHTML = filterHtml;

                        genreFilter.addEventListener('click', function(e) {
                            var btn = e.target.closest('.genre-btn');
                            if (!btn) return;
                            var genre = btn.getAttribute('data-genre');
                            genreFilter.querySelectorAll('.genre-btn').forEach(function(b) { b.classList.remove('active'); });
                            btn.classList.add('active');
                            var cards = picksGrid.querySelectorAll('.pick-card');
                            cards.forEach(function(card) {
                                if (genre === 'all') {
                                    card.style.display = '';
                                } else {
                                    var cardGenres = (card.getAttribute('data-genres') || '').split(',');
                                    card.style.display = cardGenres.indexOf(genre) !== -1 ? '' : 'none';
                                }
                            });
                        });
                    }

                    // Card click to play
                    var cards = picksGrid.querySelectorAll('.pick-card');
                    for (var j = 0; j < cards.length; j++) {
                        cards[j].addEventListener('click', function(e) {
                            // Don't trigger if clicking tracklist elements
                            if (e.target.classList.contains('pick-tracklist-toggle') ||
                                e.target.classList.contains('track-time') ||
                                e.target.closest('.pick-tracklist')) {
                                return;
                            }
                            playPick(this.getAttribute('data-url'), this.getAttribute('data-title'));
                        });
                    }

                    // Tracklist toggle click
                    var toggles = picksGrid.querySelectorAll('.pick-tracklist-toggle');
                    for (var k = 0; k < toggles.length; k++) {
                        toggles[k].addEventListener('click', function(e) {
                            e.stopPropagation();
                            var tracklist = this.nextElementSibling;
                            tracklist.classList.toggle('open');
                            this.textContent = tracklist.classList.contains('open') ?
                                'Hide Tracklist' : 'Tracklist (' + tracklist.children.length + ')';
                        });
                    }

                    // Track time click to seek
                    var times = picksGrid.querySelectorAll('.track-time');
                    for (var m = 0; m < times.length; m++) {
                        times[m].addEventListener('click', function(e) {
                            e.stopPropagation();
                            var url = this.getAttribute('data-url');
                            var time = parseInt(this.getAttribute('data-time'), 10);
                            var setData = setsData[url];
                            if (setData) {
                                playPick(url, setData.title, time);
                            }
                        });
                    }

                    // Help ID click to open modal
                    var helpIds = picksGrid.querySelectorAll('.help-id');
                    for (var h = 0; h < helpIds.length; h++) {
                        helpIds[h].addEventListener('click', function(e) {
                            e.stopPropagation();
                            var setName = this.getAttribute('data-set');
                            var startTime = parseInt(this.getAttribute('data-start'), 10);
                            var timeRange = this.getAttribute('data-range');
                            openHelpIdModal(setName, startTime, timeRange);
                        });
                    }
                    // Handle ?set= URL param — direct shareable link to any set (staff pick or unlisted)
                    var urlParams = new URLSearchParams(window.location.search);
                    var setParam = urlParams.get('set');
                    if (setParam) {
                        var directUrl = '/hls-vod/' + setParam + '.m3u8';
                        var matchedSet = data.sets.find(function(s) { return s.url === directUrl; });
                        var directTitle = urlParams.get('title') || (matchedSet ? displayPickTitle(matchedSet) : setParam);
                        playPick(directUrl, directTitle);
                        setTimeout(function() {
                            document.getElementById('ronaut-player').scrollIntoView({ behavior: 'smooth' });
                        }, 500);
                    }

                } catch (err) {
                    console.error('Failed to load staff picks:', err);
                }
            }

            loadStaffPicks();
        })();

        // Chat
        (function() {
            var socket = io('https://stream.ronautradio.la', { path: '/ws/' });
            var messagesDiv = document.getElementById('chat-messages');
            var nickInput = document.getElementById('chat-nick');
            var msgInput = document.getElementById('chat-msg');
            var sendBtn = document.getElementById('chat-send');
            var onlineSpan = document.getElementById('chat-online');

            // Generate a persistent anon name if user never sets one
            function generateAnonName() {
                var chars = '0123456789abcdef';
                var id = '';
                for (var i = 0; i < 4; i++) {
                    id += chars[Math.floor(Math.random() * chars.length)];
                }
                return 'anon' + id;
            }

            // Get or create persistent nickname
            function getOrCreateNickname() {
                var saved = localStorage.getItem('ronaut_chat_nick');
                if (saved) return saved;
                // Generate and save a persistent anon name
                var anon = generateAnonName();
                localStorage.setItem('ronaut_chat_nick', anon);
                return anon;
            }

            // Restore nickname from localStorage (or generate one)
            nickInput.value = getOrCreateNickname();

            function formatChatTime(timestamp) {
                var d = new Date(timestamp * 1000);
                var hours = d.getHours().toString().padStart(2, '0');
                var mins = d.getMinutes().toString().padStart(2, '0');
                return hours + ':' + mins;
            }

            function appendMessage(data) {
                var div = document.createElement('div');
                div.className = 'chat-msg';
                // Timestamp
                var timeSpan = document.createElement('span');
                timeSpan.className = 'chat-time';
                timeSpan.textContent = formatChatTime(data.timestamp);
                div.appendChild(timeSpan);
                // Nickname
                var nick = document.createElement('span');
                nick.className = 'chat-nick';
                nick.style.color = data.color;
                nick.textContent = data.nickname;
                div.appendChild(nick);
                // Message text
                var text = document.createTextNode(data.message);
                div.appendChild(text);
                messagesDiv.appendChild(div);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            socket.on('history', function(messages) {
                messagesDiv.innerHTML = '';
                for (var i = 0; i < messages.length; i++) {
                    appendMessage(messages[i]);
                }
            });

            // Track last locally-echoed message to avoid showing it twice
            var _lastSent = null;
            socket.on('new_message', function(data) {
                // Skip server echo if we already displayed this message optimistically
                if (_lastSent &&
                    data.nickname === _lastSent.nickname &&
                    data.message === _lastSent.message &&
                    Math.abs(data.timestamp - _lastSent.timestamp) < 5) {
                    _lastSent = null;
                    return;
                }
                appendMessage(data);
            });

            socket.on('user_count', function(data) {
                onlineSpan.textContent = data.count + ' online';
            });

            socket.on('error', function(data) {
                msgInput.style.borderColor = '#ff0000';
                setTimeout(function() { msgInput.style.borderColor = ''; }, 1000);
            });

            // Simple deterministic color from nickname (mirrors server logic)
            function _nickColor(name) {
                var h = 0;
                for (var i = 0; i < name.length; i++) {
                    h = Math.imul(31, h) + name.charCodeAt(i) | 0;
                }
                var r = (Math.abs(h) % 128) + 40;
                var g = (Math.abs(h >> 8) % 128) + 40;
                var b = (Math.abs(h >> 16) % 128) + 40;
                return '#' + ('0' + r.toString(16)).slice(-2) + ('0' + g.toString(16)).slice(-2) + ('0' + b.toString(16)).slice(-2);
            }

            function sendMessage() {
                var nick = nickInput.value.trim();
                // Use saved/generated nickname if input is empty
                if (!nick) {
                    nick = getOrCreateNickname();
                }
                var msg = msgInput.value.trim();
                if (!msg) return;
                // Save the nickname (ensures it persists)
                localStorage.setItem('ronaut_chat_nick', nick);
                nickInput.value = nick; // Update input to show the name being used

                // Show message locally immediately (works even if socket is slow)
                var now = Date.now() / 1000;
                var localData = { nickname: nick, message: msg, color: _nickColor(nick), timestamp: now };
                _lastSent = localData;
                appendMessage(localData);

                socket.emit('send_message', { nickname: nick, message: msg });
                msgInput.value = '';
            }

            sendBtn.addEventListener('click', sendMessage);
            msgInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        })();

        // Share Button
        (function() {
            const shareButton = document.getElementById("btn-share");
            const shareData = {
                title: "Ronaut Radio",
                text: "Listening to Ronaut Radio!",
                url: "https://ronautradio.la"
            };

            if (navigator.share) {
                shareButton.addEventListener("click", async () => {
                    try {
                        await navigator.share(shareData);
                    } catch (err) {
                        console.error("Share failed:", err);
                    }
                });
            } else {
                 shareButton.addEventListener("click", () => {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(shareData.url).then(() => {
                            alert('Link copied to clipboard!');
                        }).catch((err) => {
                            console.error('Failed to copy: ', err);
                            prompt('Copy this link to share:', shareData.url);
                        });
                    } else {
                        prompt('Copy this link to share:', shareData.url);
                    }
                });
            }
        })();

        // Theme Toggle (Dark/Light Mode)
        (function() {
            var themeBtn = document.getElementById('btn-theme');
            var html = document.documentElement;

            // Check for saved theme or system preference
            var savedTheme = localStorage.getItem('ronaut_theme');
            if (savedTheme) {
                html.setAttribute('data-theme', savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                html.setAttribute('data-theme', 'dark');
            }

            // Toggle theme on button click
            themeBtn.addEventListener('click', function() {
                var currentTheme = html.getAttribute('data-theme');
                var newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('ronaut_theme', newTheme);
            });

            // Listen for system theme changes
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                    if (!localStorage.getItem('ronaut_theme')) {
                        html.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                    }
                });
            }
        })();

        // Shopify
        (function() {
            var scriptURL = 'https://sdks.shopifycdn.com/buy-button/latest/buy-button-storefront.min.js';
            if (window.ShopifyBuy) {
                if (window.ShopifyBuy.UI) { ShopifyBuyInit(); } else { loadScript(); }
            } else {
                loadScript();
            }
            function loadScript() {
                var script = document.createElement('script');
                script.async = true;
                script.src = scriptURL;
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(script);
                script.onload = ShopifyBuyInit;
            }
            function ShopifyBuyInit() {
                var client = ShopifyBuy.buildClient({
                    domain: 'ronautradio.myshopify.com',
                    storefrontAccessToken: '686cfe8cf0b79c6521c19106239159c3',
                });
                ShopifyBuy.UI.onReady(client).then(function(ui) {
                    ui.createComponent('collection', {
                        id: '187376926808',
                        node: document.getElementById('collection-component-1618238023055'),
                        moneyFormat: '%24%7B%7Bamount%7D%7D',
                        options: { "product": { "styles": { "product": { "@media (min-width: 601px)": { "max-width": "calc(25% - 20px)", "margin-left": "20px", "margin-bottom": "50px", "width": "calc(25% - 20px)" }, "img": { "height": "calc(100% - 15px)", "position": "absolute", "left": "0", "right": "0", "top": "0" }, "imgWrapper": { "padding-top": "calc(75% + 15px)", "position": "relative", "height": "0" } }, "title": { "font-size": "14px" }, "button": { ":hover": { "background-color": "#000000" }, "background-color": "#000000", ":focus": { "background-color": "#000000" }, "padding-left": "50px", "padding-right": "50px" } }, "text": { "button": "Add to cart" } }, "productSet": { "styles": { "products": { "@media (min-width: 601px)": { "margin-left": "-20px" } } } }, "modalProduct": { "contents": { "img": false, "imgWithCarousel": true, "button": false, "buttonWithQuantity": true }, "styles": { "product": { "@media (min-width: 601px)": { "max-width": "100%", "margin-left": "0px", "margin-bottom": "0px" } }, "button": { ":hover": { "background-color": "#000000" }, "background-color": "#000000", ":focus": { "background-color": "#000000" }, "padding-left": "50px", "padding-right": "50px" }, "title": { "font-family": "Helvetica Neue, sans-serif", "font-weight": "bold", "font-size": "26px", "color": "#4c4c4c" } }, "text": { "button": "Add to cart" } }, "option": {}, "cart": { "styles": { "button": { ":hover": { "background-color": "#000000" }, "background-color": "#000000", ":focus": { "background-color": "#000000" } } }, "text": { "total": "Subtotal", "button": "Checkout" }, "contents": { "note": true } }, "toggle": { "styles": { "toggle": { "background-color": "#000000", ":hover": { "background-color": "#000000" }, ":focus": { "background-color": "#000000" } } } } },
                    });
                });
            }
        })();

        // Upcoming Events - Fetch ICS and render cards
        var upcomingEvents = [];
        var nextLiveBannerText = '';

        function parseICS(icsText) {
            var events = [];
            var lines = icsText.split('\n');
            var currentEvent = null;

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    if (currentEvent.summary && currentEvent.dtstart) {
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    if (line.startsWith('SUMMARY:')) {
                        currentEvent.summary = line.substring(8);
                    } else if (line.startsWith('DTSTART:')) {
                        var dtStr = line.substring(8).replace('Z', '');
                        currentEvent.dtstart = new Date(
                            dtStr.substring(0,4) + '-' + dtStr.substring(4,6) + '-' + dtStr.substring(6,8) + 'T' +
                            dtStr.substring(9,11) + ':' + dtStr.substring(11,13) + ':' + dtStr.substring(13,15) + 'Z'
                        );
                    } else if (line.startsWith('DTEND:')) {
                        var dtEndStr = line.substring(6).replace('Z', '');
                        currentEvent.dtend = new Date(
                            dtEndStr.substring(0,4) + '-' + dtEndStr.substring(4,6) + '-' + dtEndStr.substring(6,8) + 'T' +
                            dtEndStr.substring(9,11) + ':' + dtEndStr.substring(11,13) + ':' + dtEndStr.substring(13,15) + 'Z'
                        );
                    }
                }
            }
            return events;
        }

        function toGoogleDate(d) {
            return d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
        }

        function createEventCard(event) {
            var start = event.dtstart;
            var end = event.dtend || new Date(start.getTime() + 3600000);

            var monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            // Convert to Pacific Time for display
            var options = { timeZone: 'America/Los_Angeles' };
            var ptDate = new Date(start.toLocaleString('en-US', options));
            var month = start.toLocaleString('en-US', { month: 'short', timeZone: 'America/Los_Angeles' }).toUpperCase();
            var day = start.toLocaleString('en-US', { day: 'numeric', timeZone: 'America/Los_Angeles' });
            var weekday = start.toLocaleString('en-US', { weekday: 'short', timeZone: 'America/Los_Angeles' });
            var timeStr = start.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', timeZone: 'America/Los_Angeles' }) + ' PT';

            var gcalUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE' +
                '&text=' + encodeURIComponent(event.summary) +
                '&dates=' + toGoogleDate(start) + '/' + toGoogleDate(end) +
                '&details=' + encodeURIComponent('Ronaut Radio Live Stream - ronautradio.la');

            var icsContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\n' +
                'DTSTART:' + toGoogleDate(start) + '\n' +
                'DTEND:' + toGoogleDate(end) + '\n' +
                'SUMMARY:' + event.summary + '\n' +
                'DESCRIPTION:Ronaut Radio Live Stream - ronautradio.la\n' +
                'END:VEVENT\nEND:VCALENDAR';
            var icsBlob = new Blob([icsContent], { type: 'text/calendar' });
            var icsUrl = URL.createObjectURL(icsBlob);

            var card = document.createElement('div');
            card.className = 'event-card';
            card.innerHTML =
                '<div class="event-date">' +
                    '<span class="month">' + month + '</span>' +
                    '<span class="day">' + day + '</span>' +
                    '<span class="weekday">' + weekday + '</span>' +
                '</div>' +
                '<div class="event-details">' +
                    '<h3 class="event-title">' + event.summary + '</h3>' +
                    '<p class="event-time">' + timeStr + '</p>' +
                '</div>' +
                '<div class="event-actions">' +
                    '<a href="' + gcalUrl + '" target="_blank" class="add-gcal">+ Google</a>' +
                    '<a href="' + icsUrl + '" download="' + event.summary.replace(/[^a-z0-9]/gi, '-') + '.ics" class="add-ics">.ics</a>' +
                '</div>';

            return card;
        }

        function renderUpcomingEvents() {
            var container = document.getElementById('upcoming-events');
            var noUpcoming = document.getElementById('no-upcoming');
            var now = new Date();

            // Filter to future events and sort
            var futureEvents = upcomingEvents.filter(function(e) { return e.dtstart > now; });
            futureEvents.sort(function(a, b) { return a.dtstart - b.dtstart; });

            container.innerHTML = '';

            if (futureEvents.length === 0) {
                noUpcoming.style.display = 'block';
            } else {
                noUpcoming.style.display = 'none';
                futureEvents.forEach(function(event) {
                    container.appendChild(createEventCard(event));
                });
            }

            // Update banner with next event
            if (futureEvents.length > 0) {
                var nextEvent = futureEvents[0];
                var startDate = nextEvent.dtstart;
                var options = { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZone: 'America/Los_Angeles' };
                var dateStr = startDate.toLocaleString('en-US', options);
                nextLiveBannerText = 'Next Live: ' + nextEvent.summary + ' — ' + dateStr;
                document.getElementById('next-live-banner').textContent = nextLiveBannerText;
                startBannerCycle();
            }
        }

        // Fetch calendar
        fetch('https://stream.ronautradio.la/api/calendar.ics')
            .then(function(response) { return response.text(); })
            .then(function(icsText) {
                upcomingEvents = parseICS(icsText);
                console.log('Calendar loaded, events:', upcomingEvents.length);
                renderUpcomingEvents();
            })
            .catch(function(err) {
                console.error('Calendar fetch error:', err);
                document.getElementById('no-upcoming').style.display = 'block';
            });

        function startBannerCycle() {
            var banner = document.getElementById('next-live-banner');
            if (!nextLiveBannerText) return;

            // Show banner immediately first time
            showBanner();

            // Then cycle: show for 5s, hide for 25s
            setInterval(function() {
                showBanner();
            }, 60000); // Every 60 seconds
        }

        function showBanner() {
            var banner = document.getElementById('next-live-banner');
            if (!nextLiveBannerText) return;

            banner.classList.add('visible');

            // Hide after 5 seconds
            setTimeout(function() {
                banner.classList.remove('visible');
            }, 5000);
        }
    });
    </script>

    <!-- Asteroid Background Animation -->
    <script>
    (function() {
        var canvas = document.getElementById('asteroid-canvas');
        if (!canvas) return;
        var ctx = canvas.getContext('2d');

        function isDarkMode() {
            return document.documentElement.getAttribute('data-theme') === 'dark';
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Speed line class (from cartoon HTML)
        function SpeedLine(x, y, vx, vy, angle) {
            this.x = x;
            this.y = y;
            this.length = Math.random() * 20 + 10;
            this.width = Math.random() * 2 + 1;
            this.angle = angle + (Math.random() - 0.5) * 0.3;
            this.life = 1.0;
            this.decay = 0.02 + Math.random() * 0.02;
            this.speed = Math.random() * 2 + 1;
        }
        SpeedLine.prototype.update = function() {
            // Move in the trail direction (towards top-left)
            this.x += Math.cos(this.angle) * this.speed;
            this.y += Math.sin(this.angle) * this.speed;
            this.life -= this.decay;
            this.length *= 0.98;
        };
        SpeedLine.prototype.draw = function() {
            if (this.life <= 0) return;
            ctx.save();
            ctx.globalAlpha = this.life * 0.7;
            ctx.strokeStyle = isDarkMode() ? '#ffffff' : '#000000';
            ctx.lineWidth = this.width;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(this.x, this.y);
            // Draw line extending in the trail direction
            ctx.lineTo(this.x + Math.cos(this.angle) * this.length, this.y + Math.sin(this.angle) * this.length);
            ctx.stroke();
            ctx.restore();
        };

        // Debris particle class (from cartoon HTML)
        function DebrisParticle(x, y, vx, vy) {
            this.x = x;
            this.y = y;
            this.vx = vx + (Math.random() - 0.5) * 2;
            this.vy = vy + (Math.random() - 0.5) * 2;
            this.size = Math.random() * 3 + 1;
            this.life = 1.0;
            this.decay = 0.015 + Math.random() * 0.015;
            this.rotation = Math.random() * Math.PI * 2;
            this.rotationSpeed = (Math.random() - 0.5) * 0.2;
        }
        DebrisParticle.prototype.update = function() {
            this.x += this.vx;
            this.y += this.vy;
            this.rotation += this.rotationSpeed;
            this.life -= this.decay;
            this.vx *= 0.97;
            this.vy *= 0.97;
        };
        DebrisParticle.prototype.draw = function() {
            if (this.life <= 0) return;
            ctx.save();
            ctx.globalAlpha = this.life * 0.6;
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            var dark = isDarkMode();
            ctx.fillStyle = dark ? '#cccccc' : '#333333';
            ctx.strokeStyle = dark ? '#ffffff' : '#000000';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(this.size, 0);
            ctx.lineTo(this.size * 0.5, this.size * 0.5);
            ctx.lineTo(-this.size * 0.5, this.size * 0.3);
            ctx.lineTo(-this.size * 0.3, -this.size * 0.5);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.restore();
        };

        // Cartoony Asteroid class (from cartoon HTML with slingshot movement)
        function CartoonAsteroid() {
            this.init();
        }
        CartoonAsteroid.prototype.init = function() {
            // Meteor shower: spawn from top-left area, move to bottom-right
            // Spawn along top edge and left edge
            if (Math.random() > 0.5) {
                // Spawn from top
                this.startX = Math.random() * canvas.width * 0.7;
                this.startY = -this.size - Math.random() * 100;
            } else {
                // Spawn from left
                this.startX = -this.size - Math.random() * 50;
                this.startY = Math.random() * canvas.height * 0.5;
            }
            this.x = this.startX;
            this.y = this.startY;
            this.size = window.innerWidth < 768 ? Math.random() * 6 + 3 : Math.random() * 22 + 10; // mobile: 3-9px, desktop: 10-32px
            this.speed = (Math.random() * 1.5 + 0.5); // Diagonal speed

            // Meteor angle (roughly 45 degrees, slight variation)
            this.angle = Math.PI * 0.25 + (Math.random() - 0.5) * 0.2;
            this.vx = Math.cos(this.angle) * this.speed;
            this.vy = Math.sin(this.angle) * this.speed;

            this.rotation = Math.random() * Math.PI * 2;
            this.rotationSpeed = (Math.random() - 0.5) * 0.05;

            // Cartoony features
            this.craters = [];
            var craterCount = Math.floor(Math.random() * 4) + 2;
            for (var i = 0; i < craterCount; i++) {
                this.craters.push({
                    angle: Math.random() * Math.PI * 2,
                    distance: Math.random() * 0.5,
                    size: Math.random() * 0.3 + 0.15
                });
            }
            this.bumps = [];
            var bumpCount = Math.floor(Math.random() * 4) + 6; // More bumps for detail
            for (var i = 0; i < bumpCount; i++) {
                // Add randomness to angles for irregular shape
                var baseAngle = (i / bumpCount) * Math.PI * 2;
                var angleVariation = (Math.random() - 0.5) * (Math.PI / bumpCount) * 0.8;
                this.bumps.push({
                    angle: baseAngle + angleVariation,
                    radius: 0.5 + Math.random() * 0.6 // More variation (0.5-1.1 instead of 0.7-1.0)
                });
            }
            // Sort bumps by angle to maintain proper shape
            this.bumps.sort(function(a, b) { return a.angle - b.angle; });

            // Multiple shine spots on leading edge (heated front as meteor burns)
            this.shines = [];
            var shineCount = Math.floor(Math.random() * 3) + 2; // 2-4 shines
            for (var i = 0; i < shineCount; i++) {
                this.shines.push({
                    x: 0.2 + Math.random() * 0.4, // Bottom-right quadrant (0.2 to 0.6)
                    y: 0.2 + Math.random() * 0.4,
                    size: 0.1 + Math.random() * 0.2 // 10-30% of meteor size
                });
            }
            this.opacity = 0.4 + Math.random() * 0.2;

            // Trails — faster meteors burn hotter, emit more frequently and intensely
            this.speedLines = [];
            this.debris = [];
            this.trailTimer = 0;
            this.trailInterval = Math.max(1, Math.round(3 - this.speed)); // fast=1 frame, slow=3 frames
        };
        CartoonAsteroid.prototype.emitSpeedLines = function() {
            // Speed lines trail behind meteor (towards top-left)
            var trailAngle = this.angle + Math.PI; // Opposite of travel direction
            var perpAngle = this.angle + Math.PI / 2; // Perpendicular to travel (the trailing edge)
            var lineCount = Math.round(1 + this.speed * 1.5); // fast=4 lines, slow=2 lines
            for (var i = 0; i < lineCount; i++) {
                // Spawn across the trailing surface of the meteor
                var edgeOffset = (Math.random() - 0.5) * this.size * 1.4; // Spread across meteor width
                var backOffset = this.size * 0.4 + Math.random() * this.size * 0.3; // Behind the meteor
                var spawnX = this.x + Math.cos(trailAngle) * backOffset + Math.cos(perpAngle) * edgeOffset;
                var spawnY = this.y + Math.sin(trailAngle) * backOffset + Math.sin(perpAngle) * edgeOffset;
                this.speedLines.push(new SpeedLine(
                    spawnX, spawnY,
                    0, 0, trailAngle + (Math.random() - 0.5) * 0.3
                ));
            }
        };
        CartoonAsteroid.prototype.emitDebris = function() {
            // Debris spawns from trailing surface and drifts away
            var trailAngle = this.angle + Math.PI; // Opposite of travel direction
            var perpAngle = this.angle + Math.PI / 2; // Perpendicular to travel
            var debrisCount = Math.round(0.5 + this.speed); // fast=2-3 particles, slow=1
            for (var i = 0; i < debrisCount; i++) {
                // Spawn across the trailing edge of the meteor
                var edgeOffset = (Math.random() - 0.5) * this.size * 1.2; // Spread across meteor width
                var backOffset = this.size * 0.3 + Math.random() * this.size * 0.2; // Behind the meteor
                var spawnX = this.x + Math.cos(trailAngle) * backOffset + Math.cos(perpAngle) * edgeOffset;
                var spawnY = this.y + Math.sin(trailAngle) * backOffset + Math.sin(perpAngle) * edgeOffset;
                // Velocity: faster meteors fling debris out harder
                var driftAngle = trailAngle + (Math.random() - 0.5) * 0.5;
                var particleSpeed = (Math.random() * 0.4 + 0.2) * (0.5 + this.speed * 0.5);
                var vx = Math.cos(driftAngle) * particleSpeed;
                var vy = Math.sin(driftAngle) * particleSpeed;
                this.debris.push(new DebrisParticle(spawnX, spawnY, vx, vy));
            }
        };
        CartoonAsteroid.prototype.update = function(scrollOffset, scrollDelta) {
            // Meteor shower: diagonal movement top-left to bottom-right
            // Base movement + scroll boost
            var scrollBoost = scrollDelta ? scrollDelta * 0.05 : 0;
            this.x += this.vx + Math.cos(this.angle) * scrollBoost;
            this.y += this.vy + Math.sin(this.angle) * scrollBoost;

            this.rotation += this.rotationSpeed + scrollBoost * 0.01;

            // Emit trails
            this.trailTimer++;
            if (this.trailTimer >= this.trailInterval) {
                this.emitSpeedLines();
                this.emitDebris();
                this.trailTimer = 0;
            }

            // Update particles
            for (var i = this.speedLines.length - 1; i >= 0; i--) {
                this.speedLines[i].update();
                if (this.speedLines[i].life <= 0) this.speedLines.splice(i, 1);
            }
            for (var i = this.debris.length - 1; i >= 0; i--) {
                this.debris[i].update();
                if (this.debris[i].life <= 0) this.debris.splice(i, 1);
            }

            // Respawn from top-left when exiting bottom-right
            if (this.x > canvas.width + this.size || this.y > canvas.height + this.size) {
                // Respawn from top or left edge
                if (Math.random() > 0.5) {
                    this.x = Math.random() * canvas.width * 0.7;
                    this.y = -this.size - Math.random() * 50;
                } else {
                    this.x = -this.size - Math.random() * 30;
                    this.y = Math.random() * canvas.height * 0.5;
                }
                this.speed = Math.random() * 1.5 + 0.5;
                this.angle = Math.PI * 0.25 + (Math.random() - 0.5) * 0.2;
                this.vx = Math.cos(this.angle) * this.speed;
                this.vy = Math.sin(this.angle) * this.speed;
                this.trailInterval = Math.max(1, Math.round(3 - this.speed));
                this.speedLines = [];
                this.debris = [];
            }
        };
        CartoonAsteroid.prototype.draw = function() {
            // Draw speed lines first
            for (var i = 0; i < this.speedLines.length; i++) {
                this.speedLines[i].draw();
            }
            // Draw debris
            for (var i = 0; i < this.debris.length; i++) {
                this.debris[i].draw();
            }

            // Draw asteroid
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            ctx.globalAlpha = this.opacity;

            // Draw main body with organic rocky shape using curves
            ctx.beginPath();
            var firstX, firstY;
            for (var i = 0; i < this.bumps.length; i++) {
                var bx = Math.cos(this.bumps[i].angle) * this.size * this.bumps[i].radius;
                var by = Math.sin(this.bumps[i].angle) * this.size * this.bumps[i].radius;
                if (i === 0) {
                    firstX = bx;
                    firstY = by;
                    ctx.moveTo(bx, by);
                } else {
                    // Use quadratic curves for organic rocky look
                    var prevBump = this.bumps[i - 1];
                    var prevX = Math.cos(prevBump.angle) * this.size * prevBump.radius;
                    var prevY = Math.sin(prevBump.angle) * this.size * prevBump.radius;
                    // Control point slightly inward for jagged rock feel
                    var midAngle = (prevBump.angle + this.bumps[i].angle) / 2;
                    var cpRadius = this.size * (prevBump.radius + this.bumps[i].radius) / 2 * 0.85;
                    var cpX = Math.cos(midAngle) * cpRadius;
                    var cpY = Math.sin(midAngle) * cpRadius;
                    ctx.quadraticCurveTo(cpX, cpY, bx, by);
                }
            }
            // Close path with curve back to first point
            var lastBump = this.bumps[this.bumps.length - 1];
            var lastX = Math.cos(lastBump.angle) * this.size * lastBump.radius;
            var lastY = Math.sin(lastBump.angle) * this.size * lastBump.radius;
            var closeMidAngle = (lastBump.angle + this.bumps[0].angle + Math.PI * 2) / 2;
            var closeCpRadius = this.size * (lastBump.radius + this.bumps[0].radius) / 2 * 0.85;
            var closeCpX = Math.cos(closeMidAngle) * closeCpRadius;
            var closeCpY = Math.sin(closeMidAngle) * closeCpRadius;
            ctx.quadraticCurveTo(closeCpX, closeCpY, firstX, firstY);
            ctx.closePath();

            // Fill with gradient for 3D effect
            var gradient = ctx.createRadialGradient(-this.size * 0.3, -this.size * 0.3, 0, 0, 0, this.size * 1.2);
            var dark = isDarkMode();
            if (dark) {
                gradient.addColorStop(0, '#666666');
                gradient.addColorStop(0.7, '#333333');
                gradient.addColorStop(1, '#1a1a1a');
            } else {
                gradient.addColorStop(0, '#888888');
                gradient.addColorStop(0.7, '#444444');
                gradient.addColorStop(1, '#222222');
            }
            ctx.fillStyle = gradient;
            ctx.fill();

            // Bold outline
            ctx.strokeStyle = dark ? '#ffffff' : '#000000';
            ctx.lineWidth = 2.5;
            ctx.lineJoin = 'round';
            ctx.stroke();

            // Draw craters
            for (var i = 0; i < this.craters.length; i++) {
                var crater = this.craters[i];
                var cx = Math.cos(crater.angle) * this.size * crater.distance;
                var cy = Math.sin(crater.angle) * this.size * crater.distance;
                var radius = this.size * crater.size;

                ctx.beginPath();
                ctx.arc(cx, cy, radius, 0, Math.PI * 2);
                ctx.fillStyle = dark ? '#1a1a1a' : '#000000';
                ctx.fill();
                ctx.strokeStyle = dark ? '#ffffff' : '#000000';
                ctx.lineWidth = 1.5;
                ctx.stroke();

                // Crater highlight
                ctx.beginPath();
                ctx.arc(cx - radius * 0.3, cy - radius * 0.3, radius * 0.3, 0, Math.PI * 2);
                ctx.fillStyle = dark ? '#444444' : '#666666';
                ctx.fill();
            }

            // Add cartoon shines (multiple overlapping)
            for (var i = 0; i < this.shines.length; i++) {
                var shine = this.shines[i];
                ctx.beginPath();
                ctx.arc(this.size * shine.x, this.size * shine.y, this.size * shine.size, 0, Math.PI * 2);
                ctx.fillStyle = dark ? 'rgba(255, 255, 255, 0.25)' : 'rgba(255, 255, 255, 0.35)';
                ctx.fill();
            }

            ctx.restore();
        };

        // Create asteroids (fewer on mobile)
        var asteroids = [];
        var asteroidCount = window.innerWidth < 768 ? 3 : 7;
        for (var i = 0; i < asteroidCount; i++) {
            asteroids.push(new CartoonAsteroid());
        }

        // Silver Surfer - rare sighting!
        var surferImage = new Image();
        surferImage.src = 'assets/silver-surfer.png';
        var silverSurfer = null;
        var surferSpawnInterval = 45000; // Check every 45 seconds
        var surferSpawnChance = 0.15; // 15% chance

        function SilverSurfer() {
            this.init();
        }
        SilverSurfer.prototype.init = function() {
            this.size = 150; // Much larger than meteors
            // Spawn from top or left
            if (Math.random() > 0.5) {
                this.x = Math.random() * canvas.width * 0.5;
                this.y = -this.size - Math.random() * 100;
            } else {
                this.x = -this.size - Math.random() * 50;
                this.y = Math.random() * canvas.height * 0.3;
            }
            this.speed = 1.2; // Smooth glide
            this.angle = Math.PI * 0.25 + (Math.random() - 0.5) * 0.15;
            this.vx = Math.cos(this.angle) * this.speed;
            this.vy = Math.sin(this.angle) * this.speed;
            this.opacity = 0.85;
            this.speedLines = [];
            this.debris = [];
            this.trailTimer = 0;
            this.trailInterval = 3;
            this.active = true;
        };
        SilverSurfer.prototype.emitSpeedLines = function() {
            var trailAngle = this.angle + Math.PI;
            // Spawn from surfboard (bottom of image)
            var boardY = this.y + this.size * 0.4; // Bottom area where surfboard is
            var boardX = this.x;
            for (var i = 0; i < 2; i++) {
                var edgeOffset = (Math.random() - 0.5) * this.size * 0.5; // Narrower, just board width
                var backOffset = this.size * 0.1 + Math.random() * this.size * 0.1;
                var spawnX = boardX + Math.cos(trailAngle) * backOffset + edgeOffset;
                var spawnY = boardY + Math.sin(trailAngle) * backOffset;
                this.speedLines.push(new SpeedLine(spawnX, spawnY, 0, 0, trailAngle + (Math.random() - 0.5) * 0.2));
            }
        };
        SilverSurfer.prototype.emitDebris = function() {
            var trailAngle = this.angle + Math.PI;
            // Spawn from surfboard (bottom of image)
            var boardY = this.y + this.size * 0.4;
            var boardX = this.x;
            for (var i = 0; i < 2; i++) {
                var edgeOffset = (Math.random() - 0.5) * this.size * 0.4; // Board width
                var backOffset = this.size * 0.05 + Math.random() * this.size * 0.1;
                var spawnX = boardX + Math.cos(trailAngle) * backOffset + edgeOffset;
                var spawnY = boardY + Math.sin(trailAngle) * backOffset;
                var driftAngle = trailAngle + (Math.random() - 0.5) * 0.3;
                var vx = Math.cos(driftAngle) * (Math.random() * 0.5 + 0.2);
                var vy = Math.sin(driftAngle) * (Math.random() * 0.5 + 0.2);
                this.debris.push(new DebrisParticle(spawnX, spawnY, vx, vy));
            }
        };
        SilverSurfer.prototype.update = function(scrollOffset, scrollDelta) {
            var scrollBoost = scrollDelta ? scrollDelta * 0.25 : 0; // Very reactive to scrolling
            this.x += this.vx + Math.cos(this.angle) * scrollBoost;
            this.y += this.vy + Math.sin(this.angle) * scrollBoost;

            this.trailTimer++;
            if (this.trailTimer >= this.trailInterval) {
                this.emitSpeedLines();
                this.emitDebris();
                this.trailTimer = 0;
            }

            for (var i = this.speedLines.length - 1; i >= 0; i--) {
                this.speedLines[i].update();
                if (this.speedLines[i].life <= 0) this.speedLines.splice(i, 1);
            }
            for (var i = this.debris.length - 1; i >= 0; i--) {
                this.debris[i].update();
                if (this.debris[i].life <= 0) this.debris.splice(i, 1);
            }

            // Deactivate when off screen
            if (this.x > canvas.width + this.size * 2 || this.y > canvas.height + this.size * 2) {
                this.active = false;
            }
        };
        SilverSurfer.prototype.draw = function() {
            // Draw trails first
            for (var i = 0; i < this.speedLines.length; i++) {
                this.speedLines[i].draw();
            }
            for (var i = 0; i < this.debris.length; i++) {
                this.debris[i].draw();
            }

            // Draw surfer (no rotation)
            if (surferImage.complete) {
                ctx.save();
                ctx.globalAlpha = this.opacity;
                ctx.translate(this.x, this.y);
                // Standing upright - no rotation

                // Add shadow/glow for visibility on both themes
                var dark = isDarkMode();
                if (!dark) {
                    // Light mode: add dark shadow for contrast
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;
                } else {
                    // Dark mode: add subtle glow
                    ctx.shadowColor = 'rgba(255, 255, 255, 0.3)';
                    ctx.shadowBlur = 10;
                }

                ctx.drawImage(surferImage, -this.size / 2, -this.size / 2, this.size, this.size);
                ctx.restore();
            }
        };

        // Spawn checker - 5% chance every 45 seconds
        function checkSurferSpawn() {
            if (!silverSurfer || !silverSurfer.active) {
                if (Math.random() < surferSpawnChance) {
                    silverSurfer = new SilverSurfer();
                    console.log('🏄 Silver Surfer sighting!');
                }
            }
        }
        setInterval(checkSurferSpawn, surferSpawnInterval);

        var scrollOffset = 0;
        var lastScrollOffset = 0;
        var scrollDelta = 0;
        window.addEventListener('scroll', function() {
            var newOffset = window.pageYOffset;
            scrollDelta = newOffset - scrollOffset;
            scrollOffset = newOffset;
        });

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Calculate delta for this frame
            var frameDelta = scrollOffset - lastScrollOffset;
            lastScrollOffset = scrollOffset;
            for (var i = 0; i < asteroids.length; i++) {
                asteroids[i].update(scrollOffset, frameDelta);
                asteroids[i].draw();
            }
            // Draw Silver Surfer if active
            if (silverSurfer && silverSurfer.active) {
                silverSurfer.update(scrollOffset, frameDelta);
                silverSurfer.draw();
            }
            requestAnimationFrame(animate);
        }
        animate();
    })();
    </script>

    <!-- Mobile: scroll-driven dark mode toggle position -->
    <script>
    (function() {
        if (window.innerWidth >= 768) return;
        var themeBar = document.getElementById('theme-toggle-bar');
        var playerEl = document.getElementById('top-player-container');
        if (!themeBar || !playerEl) return;

        var rafPending = false;
        function positionThemeToggle() {
            if (rafPending) return;
            rafPending = true;
            requestAnimationFrame(function() {
                var playerBottom = playerEl.getBoundingClientRect().bottom;
                themeBar.style.top = Math.max(8, playerBottom + 6) + 'px';
                rafPending = false;
            });
        }

        window.addEventListener('scroll', positionThemeToggle, { passive: true });
        // Run once after layout settles
        setTimeout(positionThemeToggle, 100);
    })();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>
</html>